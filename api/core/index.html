
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Documentation for OKAPI - Genetic Programming for Ensemble Model Fusion">
      
      
      
      
        <link rel="prev" href="../..">
      
      
        <link rel="next" href="../nodes/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.9">
    
    
      
        <title>Core - OKAPI Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.4af4bdda.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="orange">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#core-api" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="OKAPI Documentation" class="md-header__button md-logo" aria-label="OKAPI Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            OKAPI Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Core
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/damiankucharski/OKAPI" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="OKAPI Documentation" class="md-nav__button md-logo" aria-label="OKAPI Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    OKAPI Documentation
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/damiankucharski/OKAPI" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  <span class="md-ellipsis">
    API Reference
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            API Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Core
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Core
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#okapi-class" class="md-nav__link">
    <span class="md-ellipsis">
      Okapi Class
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#okapi.okapi.Okapi" class="md-nav__link">
    <span class="md-ellipsis">
      Okapi
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#okapi.okapi.Okapi.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#okapi.okapi.Okapi.run_iteration" class="md-nav__link">
    <span class="md-ellipsis">
      run_iteration
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#okapi.okapi.Okapi.train" class="md-nav__link">
    <span class="md-ellipsis">
      train
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tree-class" class="md-nav__link">
    <span class="md-ellipsis">
      Tree Class
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#okapi.tree.Tree" class="md-nav__link">
    <span class="md-ellipsis">
      Tree
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#okapi.tree.Tree.evaluation" class="md-nav__link">
    <span class="md-ellipsis">
      evaluation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#okapi.tree.Tree.nodes_count" class="md-nav__link">
    <span class="md-ellipsis">
      nodes_count
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#okapi.tree.Tree.unique_value_node_ids" class="md-nav__link">
    <span class="md-ellipsis">
      unique_value_node_ids
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#okapi.tree.Tree.__repr__" class="md-nav__link">
    <span class="md-ellipsis">
      __repr__
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#okapi.tree.Tree.append_after" class="md-nav__link">
    <span class="md-ellipsis">
      append_after
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#okapi.tree.Tree.copy" class="md-nav__link">
    <span class="md-ellipsis">
      copy
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#okapi.tree.Tree.create_tree_from_root" class="md-nav__link">
    <span class="md-ellipsis">
      create_tree_from_root
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#okapi.tree.Tree.get_random_node" class="md-nav__link">
    <span class="md-ellipsis">
      get_random_node
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#okapi.tree.Tree.load_tree" class="md-nav__link">
    <span class="md-ellipsis">
      load_tree
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#okapi.tree.Tree.load_tree_architecture" class="md-nav__link">
    <span class="md-ellipsis">
      load_tree_architecture
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#okapi.tree.Tree.prune_at" class="md-nav__link">
    <span class="md-ellipsis">
      prune_at
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#okapi.tree.Tree.recalculate" class="md-nav__link">
    <span class="md-ellipsis">
      recalculate
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#okapi.tree.Tree.replace_at" class="md-nav__link">
    <span class="md-ellipsis">
      replace_at
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#okapi.tree.Tree.save_tree_architecture" class="md-nav__link">
    <span class="md-ellipsis">
      save_tree_architecture
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#okapi.tree.Tree.update_nodes" class="md-nav__link">
    <span class="md-ellipsis">
      update_nodes
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../nodes/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Nodes
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../operators/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Operators
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../evolution/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Evolution
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../backend/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Backend
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../utilities/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Utilities
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Development
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Development
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../development/contributing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Contributing
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#okapi-class" class="md-nav__link">
    <span class="md-ellipsis">
      Okapi Class
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#okapi.okapi.Okapi" class="md-nav__link">
    <span class="md-ellipsis">
      Okapi
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#okapi.okapi.Okapi.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#okapi.okapi.Okapi.run_iteration" class="md-nav__link">
    <span class="md-ellipsis">
      run_iteration
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#okapi.okapi.Okapi.train" class="md-nav__link">
    <span class="md-ellipsis">
      train
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tree-class" class="md-nav__link">
    <span class="md-ellipsis">
      Tree Class
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#okapi.tree.Tree" class="md-nav__link">
    <span class="md-ellipsis">
      Tree
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#okapi.tree.Tree.evaluation" class="md-nav__link">
    <span class="md-ellipsis">
      evaluation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#okapi.tree.Tree.nodes_count" class="md-nav__link">
    <span class="md-ellipsis">
      nodes_count
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#okapi.tree.Tree.unique_value_node_ids" class="md-nav__link">
    <span class="md-ellipsis">
      unique_value_node_ids
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#okapi.tree.Tree.__repr__" class="md-nav__link">
    <span class="md-ellipsis">
      __repr__
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#okapi.tree.Tree.append_after" class="md-nav__link">
    <span class="md-ellipsis">
      append_after
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#okapi.tree.Tree.copy" class="md-nav__link">
    <span class="md-ellipsis">
      copy
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#okapi.tree.Tree.create_tree_from_root" class="md-nav__link">
    <span class="md-ellipsis">
      create_tree_from_root
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#okapi.tree.Tree.get_random_node" class="md-nav__link">
    <span class="md-ellipsis">
      get_random_node
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#okapi.tree.Tree.load_tree" class="md-nav__link">
    <span class="md-ellipsis">
      load_tree
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#okapi.tree.Tree.load_tree_architecture" class="md-nav__link">
    <span class="md-ellipsis">
      load_tree_architecture
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#okapi.tree.Tree.prune_at" class="md-nav__link">
    <span class="md-ellipsis">
      prune_at
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#okapi.tree.Tree.recalculate" class="md-nav__link">
    <span class="md-ellipsis">
      recalculate
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#okapi.tree.Tree.replace_at" class="md-nav__link">
    <span class="md-ellipsis">
      replace_at
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#okapi.tree.Tree.save_tree_architecture" class="md-nav__link">
    <span class="md-ellipsis">
      save_tree_architecture
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#okapi.tree.Tree.update_nodes" class="md-nav__link">
    <span class="md-ellipsis">
      update_nodes
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="core-api">Core API<a class="headerlink" href="#core-api" title="Permanent link">&para;</a></h1>
<p>This section documents the core components of OKAPI.</p>
<h2 id="okapi-class">Okapi Class<a class="headerlink" href="#okapi-class" title="Permanent link">&para;</a></h2>
<p>The <code>Okapi</code> class is the main entry point for evolutionary model ensemble optimization.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">okapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">Okapi</span>
</code></pre></div>


<div class="doc doc-object doc-class">



<a id="okapi.okapi.Okapi"></a>
    <div class="doc doc-contents first">


        <p>Main class for evolutionary model ensemble optimization.</p>
<p>Okapi uses genetic programming to evolve tree-based ensembles of machine learning models.
The algorithm creates a population of trees where each tree represents a different way of
combining model predictions. Through evolution (crossover and mutation), it searches for
optimal ensemble structures that maximize a fitness function.</p>
<p>Each tree has ValueNodes that contain tensor predictions from individual models, and
OperatorNodes that define how to combine these predictions (e.g., mean, min, max, weighted mean).
The evolution process selects and combines high-performing trees to produce better ensembles.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="okapi.okapi.Okapi.population_size">population_size</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of individuals in the population</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="okapi.okapi.Okapi.population_multiplier">population_multiplier</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Factor determining how many additional trees to generate in each iteration</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="okapi.okapi.Okapi.tournament_size">tournament_size</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of trees to consider in tournament selection</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="okapi.okapi.Okapi.fitness_function">fitness_function</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Function used to evaluate the fitness of each tree</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="okapi.okapi.Okapi.callbacks">callbacks</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Collection of callbacks for monitoring/modifying the evolution process</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="okapi.okapi.Okapi.allowed_ops">allowed_ops</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Operator node types allowed in tree construction</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="okapi.okapi.Okapi.train_tensors">train_tensors</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary mapping model names to their prediction tensors</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="okapi.okapi.Okapi.gt_tensor">gt_tensor</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Ground truth tensor for comparison</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="okapi.okapi.Okapi.population">population</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Current population of trees</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="okapi.okapi.Okapi.additional_population">additional_population</span></code></td>
            <td>
                  <code><span title="typing.List">List</span>[<a class="autorefs autorefs-internal" title="okapi.tree.Tree" href="#okapi.tree.Tree">Tree</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional trees generated during evolution</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>







              <details class="quote">
                <summary>Source code in <code>okapi/okapi.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-0-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-0-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-0-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-0-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-0-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-0-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-0-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-0-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-0-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-0-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-0-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-0-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-0-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-0-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-0-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-0-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-0-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-0-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-0-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-0-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-0-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-0-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-0-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-0-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-0-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-0-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-0-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-0-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span>
<span class="normal"><a href="#__codelineno-0-300">300</a></span>
<span class="normal"><a href="#__codelineno-0-301">301</a></span>
<span class="normal"><a href="#__codelineno-0-302">302</a></span>
<span class="normal"><a href="#__codelineno-0-303">303</a></span>
<span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span>
<span class="normal"><a href="#__codelineno-0-306">306</a></span>
<span class="normal"><a href="#__codelineno-0-307">307</a></span>
<span class="normal"><a href="#__codelineno-0-308">308</a></span>
<span class="normal"><a href="#__codelineno-0-309">309</a></span>
<span class="normal"><a href="#__codelineno-0-310">310</a></span>
<span class="normal"><a href="#__codelineno-0-311">311</a></span>
<span class="normal"><a href="#__codelineno-0-312">312</a></span>
<span class="normal"><a href="#__codelineno-0-313">313</a></span>
<span class="normal"><a href="#__codelineno-0-314">314</a></span>
<span class="normal"><a href="#__codelineno-0-315">315</a></span>
<span class="normal"><a href="#__codelineno-0-316">316</a></span>
<span class="normal"><a href="#__codelineno-0-317">317</a></span>
<span class="normal"><a href="#__codelineno-0-318">318</a></span>
<span class="normal"><a href="#__codelineno-0-319">319</a></span>
<span class="normal"><a href="#__codelineno-0-320">320</a></span>
<span class="normal"><a href="#__codelineno-0-321">321</a></span>
<span class="normal"><a href="#__codelineno-0-322">322</a></span>
<span class="normal"><a href="#__codelineno-0-323">323</a></span>
<span class="normal"><a href="#__codelineno-0-324">324</a></span>
<span class="normal"><a href="#__codelineno-0-325">325</a></span>
<span class="normal"><a href="#__codelineno-0-326">326</a></span>
<span class="normal"><a href="#__codelineno-0-327">327</a></span>
<span class="normal"><a href="#__codelineno-0-328">328</a></span>
<span class="normal"><a href="#__codelineno-0-329">329</a></span>
<span class="normal"><a href="#__codelineno-0-330">330</a></span>
<span class="normal"><a href="#__codelineno-0-331">331</a></span>
<span class="normal"><a href="#__codelineno-0-332">332</a></span>
<span class="normal"><a href="#__codelineno-0-333">333</a></span>
<span class="normal"><a href="#__codelineno-0-334">334</a></span>
<span class="normal"><a href="#__codelineno-0-335">335</a></span>
<span class="normal"><a href="#__codelineno-0-336">336</a></span>
<span class="normal"><a href="#__codelineno-0-337">337</a></span>
<span class="normal"><a href="#__codelineno-0-338">338</a></span>
<span class="normal"><a href="#__codelineno-0-339">339</a></span>
<span class="normal"><a href="#__codelineno-0-340">340</a></span>
<span class="normal"><a href="#__codelineno-0-341">341</a></span>
<span class="normal"><a href="#__codelineno-0-342">342</a></span>
<span class="normal"><a href="#__codelineno-0-343">343</a></span>
<span class="normal"><a href="#__codelineno-0-344">344</a></span>
<span class="normal"><a href="#__codelineno-0-345">345</a></span>
<span class="normal"><a href="#__codelineno-0-346">346</a></span>
<span class="normal"><a href="#__codelineno-0-347">347</a></span>
<span class="normal"><a href="#__codelineno-0-348">348</a></span>
<span class="normal"><a href="#__codelineno-0-349">349</a></span>
<span class="normal"><a href="#__codelineno-0-350">350</a></span>
<span class="normal"><a href="#__codelineno-0-351">351</a></span>
<span class="normal"><a href="#__codelineno-0-352">352</a></span>
<span class="normal"><a href="#__codelineno-0-353">353</a></span>
<span class="normal"><a href="#__codelineno-0-354">354</a></span>
<span class="normal"><a href="#__codelineno-0-355">355</a></span>
<span class="normal"><a href="#__codelineno-0-356">356</a></span>
<span class="normal"><a href="#__codelineno-0-357">357</a></span>
<span class="normal"><a href="#__codelineno-0-358">358</a></span>
<span class="normal"><a href="#__codelineno-0-359">359</a></span>
<span class="normal"><a href="#__codelineno-0-360">360</a></span>
<span class="normal"><a href="#__codelineno-0-361">361</a></span>
<span class="normal"><a href="#__codelineno-0-362">362</a></span>
<span class="normal"><a href="#__codelineno-0-363">363</a></span>
<span class="normal"><a href="#__codelineno-0-364">364</a></span>
<span class="normal"><a href="#__codelineno-0-365">365</a></span>
<span class="normal"><a href="#__codelineno-0-366">366</a></span>
<span class="normal"><a href="#__codelineno-0-367">367</a></span>
<span class="normal"><a href="#__codelineno-0-368">368</a></span>
<span class="normal"><a href="#__codelineno-0-369">369</a></span>
<span class="normal"><a href="#__codelineno-0-370">370</a></span>
<span class="normal"><a href="#__codelineno-0-371">371</a></span>
<span class="normal"><a href="#__codelineno-0-372">372</a></span>
<span class="normal"><a href="#__codelineno-0-373">373</a></span>
<span class="normal"><a href="#__codelineno-0-374">374</a></span>
<span class="normal"><a href="#__codelineno-0-375">375</a></span>
<span class="normal"><a href="#__codelineno-0-376">376</a></span>
<span class="normal"><a href="#__codelineno-0-377">377</a></span>
<span class="normal"><a href="#__codelineno-0-378">378</a></span>
<span class="normal"><a href="#__codelineno-0-379">379</a></span>
<span class="normal"><a href="#__codelineno-0-380">380</a></span>
<span class="normal"><a href="#__codelineno-0-381">381</a></span>
<span class="normal"><a href="#__codelineno-0-382">382</a></span>
<span class="normal"><a href="#__codelineno-0-383">383</a></span>
<span class="normal"><a href="#__codelineno-0-384">384</a></span>
<span class="normal"><a href="#__codelineno-0-385">385</a></span>
<span class="normal"><a href="#__codelineno-0-386">386</a></span>
<span class="normal"><a href="#__codelineno-0-387">387</a></span>
<span class="normal"><a href="#__codelineno-0-388">388</a></span>
<span class="normal"><a href="#__codelineno-0-389">389</a></span>
<span class="normal"><a href="#__codelineno-0-390">390</a></span>
<span class="normal"><a href="#__codelineno-0-391">391</a></span>
<span class="normal"><a href="#__codelineno-0-392">392</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="k">class</span><span class="w"> </span><span class="nc">Okapi</span><span class="p">:</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="sd">    Main class for evolutionary model ensemble optimization.</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="sd">    Okapi uses genetic programming to evolve tree-based ensembles of machine learning models.</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a><span class="sd">    The algorithm creates a population of trees where each tree represents a different way of</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="sd">    combining model predictions. Through evolution (crossover and mutation), it searches for</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="sd">    optimal ensemble structures that maximize a fitness function.</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="sd">    Each tree has ValueNodes that contain tensor predictions from individual models, and</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a><span class="sd">    OperatorNodes that define how to combine these predictions (e.g., mean, min, max, weighted mean).</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a><span class="sd">    The evolution process selects and combines high-performing trees to produce better ensembles.</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a><span class="sd">    Attributes:</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a><span class="sd">        population_size: Number of individuals in the population</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a><span class="sd">        population_multiplier: Factor determining how many additional trees to generate in each iteration</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a><span class="sd">        tournament_size: Number of trees to consider in tournament selection</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a><span class="sd">        fitness_function: Function used to evaluate the fitness of each tree</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a><span class="sd">        callbacks: Collection of callbacks for monitoring/modifying the evolution process</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a><span class="sd">        allowed_ops: Operator node types allowed in tree construction</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a><span class="sd">        train_tensors: Dictionary mapping model names to their prediction tensors</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a><span class="sd">        gt_tensor: Ground truth tensor for comparison</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a><span class="sd">        population: Current population of trees</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a><span class="sd">        additional_population: Additional trees generated during evolution</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>        <span class="n">preds_source</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Path</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Path</span><span class="p">],</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>        <span class="n">gt_path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Path</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Path</span><span class="p">],</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>        <span class="n">population_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>        <span class="n">population_multiplier</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>        <span class="n">tournament_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>        <span class="n">minimize_node_count</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>        <span class="n">objective_functions</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Tree</span><span class="p">,</span> <span class="n">lib_types</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span><span class="n">average_precision_fitness</span><span class="p">,),</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>        <span class="n">objectives</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="nb">bool</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span><span class="n">maximize</span><span class="p">,),</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>        <span class="n">allowed_ops</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">OperatorNode</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span><span class="n">MEAN</span><span class="p">,</span> <span class="n">MIN</span><span class="p">,</span> <span class="n">MAX</span><span class="p">,</span> <span class="n">WEIGHTED_MEAN</span><span class="p">,</span> <span class="n">FAR_THRESHOLD</span><span class="p">,</span> <span class="n">CLOSE_THRESHOLD</span><span class="p">),</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>        <span class="n">callbacks</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Callback</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(),</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>        <span class="n">backend</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>        <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>        <span class="n">postprocessing_function</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>    <span class="p">):</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a><span class="sd">        Initialize the Okapi evolutionary algorithm.</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a><span class="sd">            preds_source: Source of model predictions, can be a path to directory or iterable of paths</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a><span class="sd">            gt_path: Path to ground truth data, can be a single path or iterable of paths. Should match preds_source by order</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a><span class="sd">            population_size: Size of the population to evolve</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a><span class="sd">            population_multiplier: Factor determining how many additional trees to generate</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a><span class="sd">            tournament_size: Number of trees to consider in tournament selection</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a><span class="sd">            minimize_node_count: Whether the pareto frontier models should also consider node count.</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a><span class="sd">            objective_functions: Functions that calculate the fitnesses that are to be optimized</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a><span class="sd">            objectives: Functions that copare two fitnesses and return True if first is better than second. Usually maximize or minimize</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a><span class="sd">            allowed_ops: Sequence of operator node types that can be used in trees</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a><span class="sd">            callbacks: Iterable of callback objects for monitoring/modifying evolution</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a><span class="sd">            backend: Optional backend implementation for tensor operations</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a><span class="sd">            seed: Random seed for reproducibility</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a><span class="sd">            postprocessing_function: Function applied after each Op Node.</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a><span class="sd">            Most of the operations may break some data characteristics, for example vector summing to one. This can be used to fix that.</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>        <span class="c1"># Validate parameters</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>        <span class="k">if</span> <span class="n">population_size</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;population_size must be positive, got </span><span class="si">{</span><span class="n">population_size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>        <span class="k">if</span> <span class="n">population_multiplier</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;population_multiplier must be positive, got </span><span class="si">{</span><span class="n">population_multiplier</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>        <span class="k">if</span> <span class="n">tournament_size</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;tournament_size must be positive, got </span><span class="si">{</span><span class="n">tournament_size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>        <span class="k">if</span> <span class="n">tournament_size</span> <span class="o">&gt;</span> <span class="n">population_size</span><span class="p">:</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>                <span class="sa">f</span><span class="s2">&quot;tournament_size (</span><span class="si">{</span><span class="n">tournament_size</span><span class="si">}</span><span class="s2">) cannot be larger than population_size (</span><span class="si">{</span><span class="n">population_size</span><span class="si">}</span><span class="s2">)&quot;</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>            <span class="p">)</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>        <span class="k">if</span> <span class="n">backend</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>            <span class="n">Backend</span><span class="o">.</span><span class="n">set_backend</span><span class="p">(</span><span class="n">backend</span><span class="p">)</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>        <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>            <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>        <span class="k">if</span> <span class="n">postprocessing_function</span><span class="p">:</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>            <span class="n">set_postprocessing_function</span><span class="p">(</span><span class="n">postprocessing_function</span><span class="p">)</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">population_size</span> <span class="o">=</span> <span class="n">population_size</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">population_multiplier</span> <span class="o">=</span> <span class="n">population_multiplier</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tournament_size</span> <span class="o">=</span> <span class="n">tournament_size</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">minimize_node_count</span> <span class="o">=</span> <span class="n">minimize_node_count</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">seed</span> <span class="o">=</span> <span class="n">seed</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">objective_functions</span> <span class="o">=</span> <span class="n">objective_functions</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">objectives</span> <span class="o">=</span> <span class="n">objectives</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">objectives</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">objective_functions</span><span class="p">),</span> <span class="s2">&quot;The number of (optimization) objectives and objective functions is not the same&quot;</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">optimal_point</span> <span class="o">=</span> <span class="n">_get_optimal_point_based_on_list_of_objective_functions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">objectives</span><span class="p">)</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span> <span class="o">=</span> <span class="n">callbacks</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">allowed_ops</span> <span class="o">=</span> <span class="n">allowed_ops</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_tensors</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gt_tensor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_train_tensors</span><span class="p">(</span><span class="n">preds_source</span><span class="p">,</span> <span class="n">gt_path</span><span class="p">)</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_tensors</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_tensors</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_input</span><span class="p">()</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>        <span class="c1"># state</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">should_stop</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">population</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_population</span><span class="p">()</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">additional_population</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tree</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># for potential callbacks</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fitnesses</span><span class="p">:</span> <span class="kc">None</span> <span class="o">|</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_call_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hook_name</span><span class="p">):</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a><span class="sd">        Call a specific hook on all registered callbacks.</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a><span class="sd">            hook_name: Name of the hook to call</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>        <span class="k">for</span> <span class="n">callback</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">:</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>            <span class="nb">getattr</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="n">hook_name</span><span class="p">)(</span><span class="bp">self</span><span class="p">)</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_initialize_population</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a><span class="sd">        Initialize the population of trees.</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a><span class="sd">        Creates simple trees using available prediction tensors.</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a><span class="sd">            List of initialized Tree objects</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initializing population with size </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">population_size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>        <span class="n">population</span> <span class="o">=</span> <span class="n">initialize_individuals</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_tensors</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">population_size</span><span class="p">)</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Population initialized with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">population</span><span class="p">)</span><span class="si">}</span><span class="s2"> individuals&quot;</span><span class="p">)</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>        <span class="k">return</span> <span class="n">population</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate_fitnesses</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trees</span><span class="p">:</span> <span class="kc">None</span> <span class="o">|</span> <span class="n">List</span><span class="p">[</span><span class="n">Tree</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]:</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a><span class="sd">        Calculate fitness values for the given trees.</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a><span class="sd">            trees: List of trees to evaluate. If None, uses the current population.</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a><span class="sd">            NumPy array of fitness values</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>        <span class="k">if</span> <span class="n">trees</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>            <span class="n">trees</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">population</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Calculating fitness for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">trees</span><span class="p">)</span><span class="si">}</span><span class="s2"> trees&quot;</span><span class="p">)</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a>        <span class="n">fitnesses</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">trees</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">objective_functions</span><span class="p">)))</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>        <span class="k">for</span> <span class="n">ix</span><span class="p">,</span> <span class="n">objective_function</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">objective_functions</span><span class="p">):</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>            <span class="n">fitnesses</span><span class="p">[:,</span> <span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">objective_function</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gt_tensor</span><span class="p">)</span> <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="n">trees</span><span class="p">])</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>        <span class="k">return</span> <span class="n">fitnesses</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">run_iteration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a><span class="sd">        Run a single iteration of the evolutionary algorithm.</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a><span class="sd">        This method:</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a><span class="sd">        1. Calculates fitness values for the current population</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a><span class="sd">        2. Performs tournament selection and crossover to create new trees</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a><span class="sd">        3. Applies mutations to some of the new trees</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a><span class="sd">        4. Removes duplicate trees from the population</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting evolution iteration&quot;</span><span class="p">)</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitnesses</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fitnesses</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_fitnesses</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">population</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>                <span class="mi">3</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>            <span class="p">)</span>  <span class="c1"># this generally unnecessarily happens again &gt; probably not with the if</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Performing tournament selection and crossover&quot;</span><span class="p">)</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitnesses</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">population</span><span class="p">)</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>        <span class="n">crossover_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_perform_crossovers</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fitnesses</span><span class="p">)</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitnesses</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">population</span><span class="p">)</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Performed </span><span class="si">{</span><span class="n">crossover_count</span><span class="si">}</span><span class="s2"> crossover operations&quot;</span><span class="p">)</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Applying mutations&quot;</span><span class="p">)</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>        <span class="n">mutation_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mutate_additional_population</span><span class="p">()</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitnesses</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">population</span><span class="p">)</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Applied </span><span class="si">{</span><span class="n">mutation_count</span><span class="si">}</span><span class="s2"> mutations&quot;</span><span class="p">)</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>        <span class="n">joined_population</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">population</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">additional_population</span><span class="p">)</span>  <span class="c1"># maybe worth it to calculated fitnesses first?</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>        <span class="n">codes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">tree</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span> <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="n">joined_population</span><span class="p">])</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>        <span class="n">mask</span> <span class="o">=</span> <span class="n">first_uniques_mask</span><span class="p">(</span><span class="n">codes</span><span class="p">)</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">population</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">joined_population</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fitnesses</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_fitnesses</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">population</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitnesses</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">population</span><span class="p">)</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Removed </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">joined_population</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span><span class="si">}</span><span class="s2"> duplicate trees&quot;</span><span class="p">)</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;New population size: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">population</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">population</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitnesses</span> <span class="o">=</span> <span class="n">choose_pareto_then_proximity</span><span class="p">(</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">population</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitnesses</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">objectives</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">population_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">minimize_node_count</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>        <span class="p">)</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitnesses</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">population</span><span class="p">)</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">additional_population</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_perform_crossovers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fitnesses</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]):</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>        <span class="n">crossover_count</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">additional_population</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">population_multiplier</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">population_size</span><span class="p">):</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>            <span class="n">idx1</span><span class="p">,</span> <span class="n">idx2</span> <span class="o">=</span> <span class="n">tournament_selection_indexes</span><span class="p">(</span><span class="n">fitnesses</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tournament_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimal_point</span><span class="p">)</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>            <span class="n">parent_1</span><span class="p">,</span> <span class="n">parent_2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">population</span><span class="p">[</span><span class="n">idx1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">population</span><span class="p">[</span><span class="n">idx2</span><span class="p">]</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>            <span class="n">new_tree_1</span><span class="p">,</span> <span class="n">new_tree_2</span> <span class="o">=</span> <span class="n">crossover</span><span class="p">(</span><span class="n">parent_1</span><span class="p">,</span> <span class="n">parent_2</span><span class="p">)</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">additional_population</span> <span class="o">+=</span> <span class="p">[</span><span class="n">new_tree_1</span><span class="p">,</span> <span class="n">new_tree_2</span><span class="p">]</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>            <span class="n">crossover_count</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>        <span class="k">return</span> <span class="n">crossover_count</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_mutate_additional_population</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>        <span class="n">mutation_count</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>        <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">additional_population</span><span class="p">:</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>            <span class="n">mutation_chance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>            <span class="k">if</span> <span class="n">mutation_chance</span> <span class="o">&lt;</span> <span class="n">tree</span><span class="o">.</span><span class="n">mutation_chance</span><span class="p">:</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>                <span class="n">allowed_mutations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">get_allowed_mutations</span><span class="p">(</span><span class="n">tree</span><span class="p">))</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>                <span class="n">chosen_mutation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">allowed_mutations</span><span class="p">)</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Applying mutation: </span><span class="si">{</span><span class="n">chosen_mutation</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a>                <span class="n">mutated_tree</span> <span class="o">=</span> <span class="n">chosen_mutation</span><span class="p">(</span>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a>                    <span class="n">tree</span><span class="p">,</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>                    <span class="n">models</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">,</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a>                    <span class="n">ids</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="p">,</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a>                    <span class="n">allowed_ops</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">allowed_ops</span><span class="p">,</span>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a>                <span class="p">)</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">additional_population</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mutated_tree</span><span class="p">)</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a>                <span class="n">mutation_count</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a>        <span class="k">return</span> <span class="n">mutation_count</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterations</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a><span class="sd">        Run the evolutionary algorithm for a specified number of iterations.</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a><span class="sd">            iterations: Number of evolution iterations to run</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting evolution with </span><span class="si">{</span><span class="n">iterations</span><span class="si">}</span><span class="s2"> iterations&quot;</span><span class="p">)</span>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_call_hook</span><span class="p">(</span><span class="s2">&quot;on_evolution_start&quot;</span><span class="p">)</span>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="o">.</span><span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">iterations</span><span class="p">)):</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generation </span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">iterations</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_call_hook</span><span class="p">(</span><span class="s2">&quot;on_generation_start&quot;</span><span class="p">)</span>  <span class="c1"># possibly move to run_iteration instead</span>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">run_iteration</span><span class="p">()</span>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_call_hook</span><span class="p">(</span><span class="s2">&quot;on_generation_end&quot;</span><span class="p">)</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">should_stop</span><span class="p">:</span>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Early stopping triggered&quot;</span><span class="p">)</span>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a>                <span class="k">break</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Evolution complete&quot;</span><span class="p">)</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_call_hook</span><span class="p">(</span><span class="s2">&quot;on_evolution_end&quot;</span><span class="p">)</span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_build_train_tensors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">preds_source</span><span class="p">,</span> <span class="n">gt_path</span><span class="p">):</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a><span class="sd">        Load prediction tensors and ground truth from files.</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a><span class="sd">            preds_source: Source of model predictions (path or iterable of paths)</span>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a><span class="sd">            gt_path: Path to ground truth data</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a><span class="sd">            Tuple of (train_tensors dictionary, ground truth tensor)</span>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Loading prediction tensors and ground truth&quot;</span><span class="p">)</span>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a>        <span class="n">tensor_paths</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">preds_source</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a>            <span class="n">preds_source</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">preds_source</span><span class="p">)</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">preds_source</span><span class="p">,</span> <span class="n">Path</span><span class="p">):</span>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Scanning directory for tensors: </span><span class="si">{</span><span class="n">preds_source</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a>            <span class="n">tensor_paths</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">preds_source</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">))</span>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a>        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">preds_source</span><span class="p">,</span> <span class="s2">&quot;__iter__&quot;</span><span class="p">):</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a>            <span class="n">marked_paths</span><span class="p">,</span> <span class="n">all_same</span> <span class="o">=</span> <span class="n">mark_paths</span><span class="p">(</span><span class="n">preds_source</span><span class="p">)</span>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a>            <span class="k">if</span> <span class="n">all_same</span><span class="p">:</span>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a>                <span class="k">if</span> <span class="n">marked_paths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;dir&quot;</span><span class="p">:</span>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a>                    <span class="k">for</span> <span class="n">pred_source</span> <span class="ow">in</span> <span class="n">preds_source</span><span class="p">:</span>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a>                        <span class="n">pred_source</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">pred_source</span><span class="p">)</span>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a>                        <span class="n">tensor_paths</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pred_source</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">))</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a>                <span class="k">elif</span> <span class="n">marked_paths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;file&quot;</span><span class="p">:</span>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a>                    <span class="n">tensor_paths</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">preds_source</span><span class="p">)</span>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a>                    <span class="s2">&quot;preds source must be either path to directory with predictions,&quot;</span>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a>                    <span class="s2">&quot; list of paths to directories with predictions, or list of paths to predictions&quot;</span>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a>                <span class="p">)</span>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a>        <span class="n">train_tensors</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a>        <span class="k">for</span> <span class="n">tensor_path</span> <span class="ow">in</span> <span class="n">tensor_paths</span><span class="p">:</span>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading tensor: </span><span class="si">{</span><span class="n">tensor_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a>            <span class="n">tensor_id</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">tensor_path</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a>            <span class="k">if</span> <span class="n">tensor_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">train_tensors</span><span class="p">:</span>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a>                <span class="n">train_tensors</span><span class="p">[</span><span class="n">tensor_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">B</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">tensor_path</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">DEVICE</span><span class="p">)</span>
<a id="__codelineno-0-309" name="__codelineno-0-309"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-310" name="__codelineno-0-310"></a>                <span class="n">train_tensors</span><span class="p">[</span><span class="n">tensor_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">B</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">train_tensors</span><span class="p">[</span><span class="n">tensor_id</span><span class="p">],</span> <span class="n">B</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">tensor_path</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">DEVICE</span><span class="p">)])</span>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a>
<a id="__codelineno-0-312" name="__codelineno-0-312"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loaded </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">train_tensors</span><span class="p">)</span><span class="si">}</span><span class="s2"> prediction tensors&quot;</span><span class="p">)</span>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading ground truth from: </span><span class="si">{</span><span class="n">gt_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-314" name="__codelineno-0-314"></a>
<a id="__codelineno-0-315" name="__codelineno-0-315"></a>        <span class="n">gt_tensor</span><span class="p">:</span> <span class="kc">None</span> <span class="o">|</span> <span class="n">Tensor</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-316" name="__codelineno-0-316"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">gt_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-317" name="__codelineno-0-317"></a>            <span class="n">gt_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">gt_path</span><span class="p">)</span>
<a id="__codelineno-0-318" name="__codelineno-0-318"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">gt_path</span><span class="p">,</span> <span class="n">Path</span><span class="p">):</span>
<a id="__codelineno-0-319" name="__codelineno-0-319"></a>            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">gt_path</span><span class="p">):</span>
<a id="__codelineno-0-320" name="__codelineno-0-320"></a>                <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">gt_path</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">):</span>
<a id="__codelineno-0-321" name="__codelineno-0-321"></a>                    <span class="k">if</span> <span class="n">gt_tensor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-322" name="__codelineno-0-322"></a>                        <span class="n">gt_tensor</span> <span class="o">=</span> <span class="n">B</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">DEVICE</span><span class="p">)</span>
<a id="__codelineno-0-323" name="__codelineno-0-323"></a>                    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-324" name="__codelineno-0-324"></a>                        <span class="n">gt_tensor</span> <span class="o">=</span> <span class="n">B</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">gt_tensor</span><span class="p">,</span> <span class="n">B</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">DEVICE</span><span class="p">)])</span>  <span class="c1"># type: ignore</span>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-326" name="__codelineno-0-326"></a>                <span class="n">gt_tensor</span> <span class="o">=</span> <span class="n">B</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">gt_path</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">DEVICE</span><span class="p">)</span>
<a id="__codelineno-0-327" name="__codelineno-0-327"></a>        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">gt_path</span><span class="p">,</span> <span class="s2">&quot;__iter__&quot;</span><span class="p">):</span>
<a id="__codelineno-0-328" name="__codelineno-0-328"></a>            <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">gt_path</span><span class="p">:</span>
<a id="__codelineno-0-329" name="__codelineno-0-329"></a>                <span class="k">if</span> <span class="n">gt_tensor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-330" name="__codelineno-0-330"></a>                    <span class="n">gt_tensor</span> <span class="o">=</span> <span class="n">B</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">DEVICE</span><span class="p">)</span>
<a id="__codelineno-0-331" name="__codelineno-0-331"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-332" name="__codelineno-0-332"></a>                    <span class="n">gt_tensor</span> <span class="o">=</span> <span class="n">B</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">gt_tensor</span><span class="p">,</span> <span class="n">B</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">DEVICE</span><span class="p">)])</span>  <span class="c1"># type: ignore</span>
<a id="__codelineno-0-333" name="__codelineno-0-333"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-334" name="__codelineno-0-334"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">gt_path</span><span class="si">}</span><span class="s2"> is not valid for loading gt&quot;</span><span class="p">)</span>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Tensors loaded successfully&quot;</span><span class="p">)</span>
<a id="__codelineno-0-337" name="__codelineno-0-337"></a>        <span class="k">return</span> <span class="n">train_tensors</span><span class="p">,</span> <span class="n">gt_tensor</span>
<a id="__codelineno-0-338" name="__codelineno-0-338"></a>
<a id="__codelineno-0-339" name="__codelineno-0-339"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fix_swapped</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>  <span class="c1"># no way to change this argument for now TODO</span>
<a id="__codelineno-0-340" name="__codelineno-0-340"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-341" name="__codelineno-0-341"></a><span class="sd">        Validate that all input tensors have compatible shapes.</span>
<a id="__codelineno-0-342" name="__codelineno-0-342"></a>
<a id="__codelineno-0-343" name="__codelineno-0-343"></a><span class="sd">        Checks if all prediction tensors have the same shape and if the ground truth</span>
<a id="__codelineno-0-344" name="__codelineno-0-344"></a><span class="sd">        tensor has a compatible shape. Can optionally fix swapped dimensions in the</span>
<a id="__codelineno-0-345" name="__codelineno-0-345"></a><span class="sd">        ground truth tensor.</span>
<a id="__codelineno-0-346" name="__codelineno-0-346"></a>
<a id="__codelineno-0-347" name="__codelineno-0-347"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-348" name="__codelineno-0-348"></a><span class="sd">            fix_swapped: If True, attempts to fix swapped dimensions in ground truth tensor</span>
<a id="__codelineno-0-349" name="__codelineno-0-349"></a>
<a id="__codelineno-0-350" name="__codelineno-0-350"></a><span class="sd">        Raises:</span>
<a id="__codelineno-0-351" name="__codelineno-0-351"></a><span class="sd">            ValueError: If tensor shapes are incompatible and cannot be fixed</span>
<a id="__codelineno-0-352" name="__codelineno-0-352"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-353" name="__codelineno-0-353"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Validating input tensors&quot;</span><span class="p">)</span>
<a id="__codelineno-0-354" name="__codelineno-0-354"></a>        <span class="c1"># check if all tensors have the same shape</span>
<a id="__codelineno-0-355" name="__codelineno-0-355"></a>        <span class="n">shapes</span> <span class="o">=</span> <span class="p">[</span><span class="n">B</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">tensor</span><span class="p">)</span> <span class="k">for</span> <span class="n">tensor</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_tensors</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
<a id="__codelineno-0-356" name="__codelineno-0-356"></a>
<a id="__codelineno-0-357" name="__codelineno-0-357"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">shapes</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-358" name="__codelineno-0-358"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tensors have different shapes: </span><span class="si">{</span><span class="n">shapes</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-359" name="__codelineno-0-359"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tensors have different shapes: </span><span class="si">{</span><span class="n">shapes</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-360" name="__codelineno-0-360"></a>
<a id="__codelineno-0-361" name="__codelineno-0-361"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;All prediction tensors have shape: </span><span class="si">{</span><span class="n">shapes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-362" name="__codelineno-0-362"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ground truth tensor has shape: </span><span class="si">{</span><span class="n">B</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gt_tensor</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-363" name="__codelineno-0-363"></a>
<a id="__codelineno-0-364" name="__codelineno-0-364"></a>        <span class="k">if</span> <span class="n">B</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gt_tensor</span><span class="p">)</span> <span class="o">!=</span> <span class="n">shapes</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
<a id="__codelineno-0-365" name="__codelineno-0-365"></a>            <span class="n">gt_shape</span> <span class="o">=</span> <span class="n">B</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gt_tensor</span><span class="p">)</span>
<a id="__codelineno-0-366" name="__codelineno-0-366"></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shapes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gt_shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">gt_shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
<a id="__codelineno-0-367" name="__codelineno-0-367"></a>                <span class="k">pass</span>
<a id="__codelineno-0-368" name="__codelineno-0-368"></a>            <span class="k">elif</span> <span class="n">fix_swapped</span><span class="p">:</span>
<a id="__codelineno-0-369" name="__codelineno-0-369"></a>                <span class="k">if</span> <span class="p">(</span><span class="n">shapes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">B</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gt_tensor</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">shapes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">2</span><span class="p">):</span>
<a id="__codelineno-0-370" name="__codelineno-0-370"></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ground truth tensor dimensions appear to be swapped. Reshaping from </span><span class="si">{</span><span class="n">B</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gt_tensor</span><span class="p">)</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">shapes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-371" name="__codelineno-0-371"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">gt_tensor</span> <span class="o">=</span> <span class="n">B</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gt_tensor</span><span class="p">,</span> <span class="n">shapes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<a id="__codelineno-0-372" name="__codelineno-0-372"></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Tensor shapes fixed successfully&quot;</span><span class="p">)</span>
<a id="__codelineno-0-373" name="__codelineno-0-373"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-374" name="__codelineno-0-374"></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ground truth tensor shape </span><span class="si">{</span><span class="n">B</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gt_tensor</span><span class="p">)</span><span class="si">}</span><span class="s2"> incompatible with prediction tensor shape </span><span class="si">{</span><span class="n">shapes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-375" name="__codelineno-0-375"></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ground truth tensor has incompatible shape: </span><span class="si">{</span><span class="n">B</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gt_tensor</span><span class="p">)</span><span class="si">}</span><span class="s2"> vs </span><span class="si">{</span><span class="n">shapes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-376" name="__codelineno-0-376"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-377" name="__codelineno-0-377"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ground truth tensor shape </span><span class="si">{</span><span class="n">B</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gt_tensor</span><span class="p">)</span><span class="si">}</span><span class="s2"> does not match prediction tensor shape </span><span class="si">{</span><span class="n">shapes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-378" name="__codelineno-0-378"></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ground truth tensor has different shape than input tensors: </span><span class="si">{</span><span class="n">shapes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> != </span><span class="si">{</span><span class="n">B</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gt_tensor</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-379" name="__codelineno-0-379"></a>
<a id="__codelineno-0-380" name="__codelineno-0-380"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Input validation successful&quot;</span><span class="p">)</span>
<a id="__codelineno-0-381" name="__codelineno-0-381"></a>
<a id="__codelineno-0-382" name="__codelineno-0-382"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-383" name="__codelineno-0-383"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">pareto_trees</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tree</span><span class="p">]:</span>
<a id="__codelineno-0-384" name="__codelineno-0-384"></a>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fitnesses</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">),</span> <span class="s2">&quot;Fitnesses not yet initialized. Did you run any iteration?&quot;</span>
<a id="__codelineno-0-385" name="__codelineno-0-385"></a>        <span class="n">all_pareto_trees</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">choose_pareto</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">population</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitnesses</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">population</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">objectives</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">minimize_node_count</span><span class="p">)</span>
<a id="__codelineno-0-386" name="__codelineno-0-386"></a>        <span class="k">return</span> <span class="n">all_pareto_trees</span>
<a id="__codelineno-0-387" name="__codelineno-0-387"></a>
<a id="__codelineno-0-388" name="__codelineno-0-388"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-389" name="__codelineno-0-389"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">pareto_fitnesses</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<a id="__codelineno-0-390" name="__codelineno-0-390"></a>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fitnesses</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">),</span> <span class="s2">&quot;Fitnesses not yet initialized. Did you run any iteration?&quot;</span>
<a id="__codelineno-0-391" name="__codelineno-0-391"></a>        <span class="n">_</span><span class="p">,</span> <span class="n">pareto_fitnesses</span> <span class="o">=</span> <span class="n">choose_pareto</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">population</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitnesses</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">population</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">objectives</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">minimize_node_count</span><span class="p">)</span>
<a id="__codelineno-0-392" name="__codelineno-0-392"></a>        <span class="k">return</span> <span class="n">pareto_fitnesses</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h2 id="okapi.okapi.Okapi.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">preds_source</span><span class="p">,</span> <span class="n">gt_path</span><span class="p">,</span> <span class="n">population_size</span><span class="p">,</span> <span class="n">population_multiplier</span><span class="p">,</span> <span class="n">tournament_size</span><span class="p">,</span> <span class="n">minimize_node_count</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">objective_functions</span><span class="o">=</span><span class="p">(</span><span class="n">average_precision_fitness</span><span class="p">,),</span> <span class="n">objectives</span><span class="o">=</span><span class="p">(</span><span class="n">maximize</span><span class="p">,),</span> <span class="n">allowed_ops</span><span class="o">=</span><span class="p">(</span><span class="n">MEAN</span><span class="p">,</span> <span class="n">MIN</span><span class="p">,</span> <span class="n">MAX</span><span class="p">,</span> <span class="n">WEIGHTED_MEAN</span><span class="p">,</span> <span class="n">FAR_THRESHOLD</span><span class="p">,</span> <span class="n">CLOSE_THRESHOLD</span><span class="p">),</span> <span class="n">callbacks</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(),</span> <span class="n">backend</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">postprocessing_function</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#okapi.okapi.Okapi.__init__" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Initialize the Okapi evolutionary algorithm.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>preds_source</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="pathlib.Path">Path</span>, <span title="str">str</span>, <span title="typing.Iterable">Iterable</span>[<span title="pathlib.Path">Path</span>], <span title="typing.Iterable">Iterable</span>[<span title="str">str</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Source of model predictions, can be a path to directory or iterable of paths</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>gt_path</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="pathlib.Path">Path</span>, <span title="str">str</span>, <span title="typing.Iterable">Iterable</span>[<span title="pathlib.Path">Path</span>], <span title="typing.Iterable">Iterable</span>[<span title="str">str</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to ground truth data, can be a single path or iterable of paths. Should match preds_source by order</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>population_size</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Size of the population to evolve</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>population_multiplier</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Factor determining how many additional trees to generate</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tournament_size</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of trees to consider in tournament selection</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>minimize_node_count</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether the pareto frontier models should also consider node count.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>objective_functions</code>
            </td>
            <td>
                  <code><span title="typing.Sequence">Sequence</span>[<span title="typing.Callable">Callable</span>[[<a class="autorefs autorefs-internal" title="okapi.tree.Tree" href="#okapi.tree.Tree">Tree</a>, <span title="okapi.lib_types.Tensor">Tensor</span>], <span title="float">float</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Functions that calculate the fitnesses that are to be optimized</p>
              </div>
            </td>
            <td>
                  <code>(<a class="autorefs autorefs-internal" title="average_precision_fitness(tree, gt, task='binary') (okapi.fitness.average_precision_fitness)" href="../utilities/#okapi.fitness.average_precision_fitness">average_precision_fitness</a>,)</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>objectives</code>
            </td>
            <td>
                  <code><span title="typing.Sequence">Sequence</span>[<span title="typing.Callable">Callable</span>[[<span title="float">float</span>, <span title="float">float</span>], <span title="bool">bool</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Functions that copare two fitnesses and return True if first is better than second. Usually maximize or minimize</p>
              </div>
            </td>
            <td>
                  <code>(<a class="autorefs autorefs-internal" title="maximize(a, b) (okapi.pareto.maximize)" href="../evolution/#okapi.pareto.maximize">maximize</a>,)</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>allowed_ops</code>
            </td>
            <td>
                  <code><span title="typing.Sequence">Sequence</span>[<span title="typing.Type">Type</span>[<a class="autorefs autorefs-internal" title="okapi.node.OperatorNode" href="../nodes/#okapi.node.OperatorNode">OperatorNode</a>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Sequence of operator node types that can be used in trees</p>
              </div>
            </td>
            <td>
                  <code>(<span title="okapi.operators.MEAN">MEAN</span>, <span title="okapi.operators.MIN">MIN</span>, <span title="okapi.operators.MAX">MAX</span>, <span title="okapi.operators.WEIGHTED_MEAN">WEIGHTED_MEAN</span>, <span title="okapi.operators.FAR_THRESHOLD">FAR_THRESHOLD</span>, <span title="okapi.operators.CLOSE_THRESHOLD">CLOSE_THRESHOLD</span>)</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>callbacks</code>
            </td>
            <td>
                  <code><span title="typing.Iterable">Iterable</span>[<a class="autorefs autorefs-internal" title="okapi.callback.Callback" href="../utilities/#okapi.callback.Callback">Callback</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Iterable of callback objects for monitoring/modifying evolution</p>
              </div>
            </td>
            <td>
                  <code><span title="tuple">tuple</span>()</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>backend</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="str">str</span>, None]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional backend implementation for tensor operations</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>seed</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Random seed for reproducibility</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>postprocessing_function</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Function applied after each Op Node.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>okapi/okapi.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-0-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-0-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-53" name="__codelineno-0-53"></a><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>    <span class="n">preds_source</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Path</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Path</span><span class="p">],</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>    <span class="n">gt_path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Path</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Path</span><span class="p">],</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>    <span class="n">population_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>    <span class="n">population_multiplier</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>    <span class="n">tournament_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>    <span class="n">minimize_node_count</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>    <span class="n">objective_functions</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Tree</span><span class="p">,</span> <span class="n">lib_types</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span><span class="n">average_precision_fitness</span><span class="p">,),</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>    <span class="n">objectives</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="nb">bool</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span><span class="n">maximize</span><span class="p">,),</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>    <span class="n">allowed_ops</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">OperatorNode</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span><span class="n">MEAN</span><span class="p">,</span> <span class="n">MIN</span><span class="p">,</span> <span class="n">MAX</span><span class="p">,</span> <span class="n">WEIGHTED_MEAN</span><span class="p">,</span> <span class="n">FAR_THRESHOLD</span><span class="p">,</span> <span class="n">CLOSE_THRESHOLD</span><span class="p">),</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>    <span class="n">callbacks</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Callback</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(),</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>    <span class="n">backend</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>    <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>    <span class="n">postprocessing_function</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a><span class="p">):</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a><span class="sd">    Initialize the Okapi evolutionary algorithm.</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a><span class="sd">        preds_source: Source of model predictions, can be a path to directory or iterable of paths</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a><span class="sd">        gt_path: Path to ground truth data, can be a single path or iterable of paths. Should match preds_source by order</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a><span class="sd">        population_size: Size of the population to evolve</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a><span class="sd">        population_multiplier: Factor determining how many additional trees to generate</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a><span class="sd">        tournament_size: Number of trees to consider in tournament selection</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a><span class="sd">        minimize_node_count: Whether the pareto frontier models should also consider node count.</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a><span class="sd">        objective_functions: Functions that calculate the fitnesses that are to be optimized</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a><span class="sd">        objectives: Functions that copare two fitnesses and return True if first is better than second. Usually maximize or minimize</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a><span class="sd">        allowed_ops: Sequence of operator node types that can be used in trees</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a><span class="sd">        callbacks: Iterable of callback objects for monitoring/modifying evolution</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a><span class="sd">        backend: Optional backend implementation for tensor operations</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a><span class="sd">        seed: Random seed for reproducibility</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a><span class="sd">        postprocessing_function: Function applied after each Op Node.</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a><span class="sd">        Most of the operations may break some data characteristics, for example vector summing to one. This can be used to fix that.</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>    <span class="c1"># Validate parameters</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>    <span class="k">if</span> <span class="n">population_size</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;population_size must be positive, got </span><span class="si">{</span><span class="n">population_size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>    <span class="k">if</span> <span class="n">population_multiplier</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;population_multiplier must be positive, got </span><span class="si">{</span><span class="n">population_multiplier</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>    <span class="k">if</span> <span class="n">tournament_size</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;tournament_size must be positive, got </span><span class="si">{</span><span class="n">tournament_size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>    <span class="k">if</span> <span class="n">tournament_size</span> <span class="o">&gt;</span> <span class="n">population_size</span><span class="p">:</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>            <span class="sa">f</span><span class="s2">&quot;tournament_size (</span><span class="si">{</span><span class="n">tournament_size</span><span class="si">}</span><span class="s2">) cannot be larger than population_size (</span><span class="si">{</span><span class="n">population_size</span><span class="si">}</span><span class="s2">)&quot;</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>        <span class="p">)</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>    <span class="k">if</span> <span class="n">backend</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>        <span class="n">Backend</span><span class="o">.</span><span class="n">set_backend</span><span class="p">(</span><span class="n">backend</span><span class="p">)</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>    <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>    <span class="k">if</span> <span class="n">postprocessing_function</span><span class="p">:</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>        <span class="n">set_postprocessing_function</span><span class="p">(</span><span class="n">postprocessing_function</span><span class="p">)</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">population_size</span> <span class="o">=</span> <span class="n">population_size</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">population_multiplier</span> <span class="o">=</span> <span class="n">population_multiplier</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">tournament_size</span> <span class="o">=</span> <span class="n">tournament_size</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">minimize_node_count</span> <span class="o">=</span> <span class="n">minimize_node_count</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">seed</span> <span class="o">=</span> <span class="n">seed</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">objective_functions</span> <span class="o">=</span> <span class="n">objective_functions</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">objectives</span> <span class="o">=</span> <span class="n">objectives</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">objectives</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">objective_functions</span><span class="p">),</span> <span class="s2">&quot;The number of (optimization) objectives and objective functions is not the same&quot;</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">optimal_point</span> <span class="o">=</span> <span class="n">_get_optimal_point_based_on_list_of_objective_functions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">objectives</span><span class="p">)</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span> <span class="o">=</span> <span class="n">callbacks</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">allowed_ops</span> <span class="o">=</span> <span class="n">allowed_ops</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">train_tensors</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gt_tensor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_train_tensors</span><span class="p">(</span><span class="n">preds_source</span><span class="p">,</span> <span class="n">gt_path</span><span class="p">)</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_tensors</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_tensors</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_validate_input</span><span class="p">()</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>    <span class="c1"># state</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">should_stop</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">population</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_population</span><span class="p">()</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">additional_population</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tree</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># for potential callbacks</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">fitnesses</span><span class="p">:</span> <span class="kc">None</span> <span class="o">|</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="okapi.okapi.Okapi.run_iteration" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">run_iteration</span><span class="p">()</span></code>

<a href="#okapi.okapi.Okapi.run_iteration" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Run a single iteration of the evolutionary algorithm.</p>
<p>This method:
1. Calculates fitness values for the current population
2. Performs tournament selection and crossover to create new trees
3. Applies mutations to some of the new trees
4. Removes duplicate trees from the population</p>


            <details class="quote">
              <summary>Source code in <code>okapi/okapi.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-174" name="__codelineno-0-174"></a><span class="k">def</span><span class="w"> </span><span class="nf">run_iteration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a><span class="sd">    Run a single iteration of the evolutionary algorithm.</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a><span class="sd">    This method:</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a><span class="sd">    1. Calculates fitness values for the current population</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a><span class="sd">    2. Performs tournament selection and crossover to create new trees</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a><span class="sd">    3. Applies mutations to some of the new trees</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a><span class="sd">    4. Removes duplicate trees from the population</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting evolution iteration&quot;</span><span class="p">)</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitnesses</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fitnesses</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_fitnesses</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">population</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>            <span class="mi">3</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>        <span class="p">)</span>  <span class="c1"># this generally unnecessarily happens again &gt; probably not with the if</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Performing tournament selection and crossover&quot;</span><span class="p">)</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitnesses</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">population</span><span class="p">)</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>    <span class="n">crossover_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_perform_crossovers</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fitnesses</span><span class="p">)</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitnesses</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">population</span><span class="p">)</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Performed </span><span class="si">{</span><span class="n">crossover_count</span><span class="si">}</span><span class="s2"> crossover operations&quot;</span><span class="p">)</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Applying mutations&quot;</span><span class="p">)</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>    <span class="n">mutation_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mutate_additional_population</span><span class="p">()</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitnesses</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">population</span><span class="p">)</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Applied </span><span class="si">{</span><span class="n">mutation_count</span><span class="si">}</span><span class="s2"> mutations&quot;</span><span class="p">)</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>    <span class="n">joined_population</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">population</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">additional_population</span><span class="p">)</span>  <span class="c1"># maybe worth it to calculated fitnesses first?</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>    <span class="n">codes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">tree</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span> <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="n">joined_population</span><span class="p">])</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>    <span class="n">mask</span> <span class="o">=</span> <span class="n">first_uniques_mask</span><span class="p">(</span><span class="n">codes</span><span class="p">)</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">population</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">joined_population</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">fitnesses</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_fitnesses</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">population</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitnesses</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">population</span><span class="p">)</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Removed </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">joined_population</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span><span class="si">}</span><span class="s2"> duplicate trees&quot;</span><span class="p">)</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;New population size: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">population</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">population</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitnesses</span> <span class="o">=</span> <span class="n">choose_pareto_then_proximity</span><span class="p">(</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">population</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitnesses</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">objectives</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">population_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">minimize_node_count</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>    <span class="p">)</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitnesses</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">population</span><span class="p">)</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">additional_population</span> <span class="o">=</span> <span class="p">[]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="okapi.okapi.Okapi.train" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">train</span><span class="p">(</span><span class="n">iterations</span><span class="p">)</span></code>

<a href="#okapi.okapi.Okapi.train" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Run the evolutionary algorithm for a specified number of iterations.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>iterations</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of evolution iterations to run</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>okapi/okapi.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-247" name="__codelineno-0-247"></a><span class="k">def</span><span class="w"> </span><span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterations</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a><span class="sd">    Run the evolutionary algorithm for a specified number of iterations.</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a><span class="sd">        iterations: Number of evolution iterations to run</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting evolution with </span><span class="si">{</span><span class="n">iterations</span><span class="si">}</span><span class="s2"> iterations&quot;</span><span class="p">)</span>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_call_hook</span><span class="p">(</span><span class="s2">&quot;on_evolution_start&quot;</span><span class="p">)</span>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="o">.</span><span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">iterations</span><span class="p">)):</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generation </span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">iterations</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_call_hook</span><span class="p">(</span><span class="s2">&quot;on_generation_start&quot;</span><span class="p">)</span>  <span class="c1"># possibly move to run_iteration instead</span>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">run_iteration</span><span class="p">()</span>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_call_hook</span><span class="p">(</span><span class="s2">&quot;on_generation_end&quot;</span><span class="p">)</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">should_stop</span><span class="p">:</span>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Early stopping triggered&quot;</span><span class="p">)</span>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a>            <span class="k">break</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Evolution complete&quot;</span><span class="p">)</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_call_hook</span><span class="p">(</span><span class="s2">&quot;on_evolution_end&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><h2 id="tree-class">Tree Class<a class="headerlink" href="#tree-class" title="Permanent link">&para;</a></h2>
<p>The <code>Tree</code> class represents a computational tree structure for model ensemble composition.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">okapi.tree</span><span class="w"> </span><span class="kn">import</span> <span class="n">Tree</span>
</code></pre></div>


<div class="doc doc-object doc-class">



<a id="okapi.tree.Tree"></a>
    <div class="doc doc-contents first">


        <p>Represents a computational tree structure for model ensemble composition.</p>
<p>The Tree class is a central component in OKAPI, representing a hierarchical structure
of nodes that define how different models are combined. Each tree has a ValueNode as its root,
and may contain multiple ValueNodes and OperatorNodes arranged in a tree structure.</p>
<p>ValueNodes contain tensor data (model predictions), while OperatorNodes define operations
to combine these predictions (such as mean, min, max, weighted mean). The tree's evaluation
produces a combined prediction by recursively applying these operations.</p>
<p>Trees can be manipulated through various operations like pruning, appending, and replacing
nodes, making them suitable for evolutionary algorithms where trees evolve over generations.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="okapi.tree.Tree.root">root</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The root node of the tree (must be a ValueNode)</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="okapi.tree.Tree.nodes">nodes</span></code></td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="list">list</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary containing lists of all value nodes and operator nodes in the tree</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="okapi.tree.Tree.mutation_chance">mutation_chance</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Probability of mutation for this tree during evolution</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>







              <details class="quote">
                <summary>Source code in <code>okapi/tree.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-0-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-0-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-0-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-0-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-0-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-0-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-0-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-0-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-0-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-0-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-0-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-0-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-0-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-0-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-0-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-0-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-0-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-0-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-0-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-0-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-0-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-0-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-0-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-0-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-0-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-0-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-0-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-0-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-0-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-0-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-0-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-0-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-0-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-0-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-0-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-0-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-0-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-0-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-0-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-0-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-0-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span>
<span class="normal"><a href="#__codelineno-0-300">300</a></span>
<span class="normal"><a href="#__codelineno-0-301">301</a></span>
<span class="normal"><a href="#__codelineno-0-302">302</a></span>
<span class="normal"><a href="#__codelineno-0-303">303</a></span>
<span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span>
<span class="normal"><a href="#__codelineno-0-306">306</a></span>
<span class="normal"><a href="#__codelineno-0-307">307</a></span>
<span class="normal"><a href="#__codelineno-0-308">308</a></span>
<span class="normal"><a href="#__codelineno-0-309">309</a></span>
<span class="normal"><a href="#__codelineno-0-310">310</a></span>
<span class="normal"><a href="#__codelineno-0-311">311</a></span>
<span class="normal"><a href="#__codelineno-0-312">312</a></span>
<span class="normal"><a href="#__codelineno-0-313">313</a></span>
<span class="normal"><a href="#__codelineno-0-314">314</a></span>
<span class="normal"><a href="#__codelineno-0-315">315</a></span>
<span class="normal"><a href="#__codelineno-0-316">316</a></span>
<span class="normal"><a href="#__codelineno-0-317">317</a></span>
<span class="normal"><a href="#__codelineno-0-318">318</a></span>
<span class="normal"><a href="#__codelineno-0-319">319</a></span>
<span class="normal"><a href="#__codelineno-0-320">320</a></span>
<span class="normal"><a href="#__codelineno-0-321">321</a></span>
<span class="normal"><a href="#__codelineno-0-322">322</a></span>
<span class="normal"><a href="#__codelineno-0-323">323</a></span>
<span class="normal"><a href="#__codelineno-0-324">324</a></span>
<span class="normal"><a href="#__codelineno-0-325">325</a></span>
<span class="normal"><a href="#__codelineno-0-326">326</a></span>
<span class="normal"><a href="#__codelineno-0-327">327</a></span>
<span class="normal"><a href="#__codelineno-0-328">328</a></span>
<span class="normal"><a href="#__codelineno-0-329">329</a></span>
<span class="normal"><a href="#__codelineno-0-330">330</a></span>
<span class="normal"><a href="#__codelineno-0-331">331</a></span>
<span class="normal"><a href="#__codelineno-0-332">332</a></span>
<span class="normal"><a href="#__codelineno-0-333">333</a></span>
<span class="normal"><a href="#__codelineno-0-334">334</a></span>
<span class="normal"><a href="#__codelineno-0-335">335</a></span>
<span class="normal"><a href="#__codelineno-0-336">336</a></span>
<span class="normal"><a href="#__codelineno-0-337">337</a></span>
<span class="normal"><a href="#__codelineno-0-338">338</a></span>
<span class="normal"><a href="#__codelineno-0-339">339</a></span>
<span class="normal"><a href="#__codelineno-0-340">340</a></span>
<span class="normal"><a href="#__codelineno-0-341">341</a></span>
<span class="normal"><a href="#__codelineno-0-342">342</a></span>
<span class="normal"><a href="#__codelineno-0-343">343</a></span>
<span class="normal"><a href="#__codelineno-0-344">344</a></span>
<span class="normal"><a href="#__codelineno-0-345">345</a></span>
<span class="normal"><a href="#__codelineno-0-346">346</a></span>
<span class="normal"><a href="#__codelineno-0-347">347</a></span>
<span class="normal"><a href="#__codelineno-0-348">348</a></span>
<span class="normal"><a href="#__codelineno-0-349">349</a></span>
<span class="normal"><a href="#__codelineno-0-350">350</a></span>
<span class="normal"><a href="#__codelineno-0-351">351</a></span>
<span class="normal"><a href="#__codelineno-0-352">352</a></span>
<span class="normal"><a href="#__codelineno-0-353">353</a></span>
<span class="normal"><a href="#__codelineno-0-354">354</a></span>
<span class="normal"><a href="#__codelineno-0-355">355</a></span>
<span class="normal"><a href="#__codelineno-0-356">356</a></span>
<span class="normal"><a href="#__codelineno-0-357">357</a></span>
<span class="normal"><a href="#__codelineno-0-358">358</a></span>
<span class="normal"><a href="#__codelineno-0-359">359</a></span>
<span class="normal"><a href="#__codelineno-0-360">360</a></span>
<span class="normal"><a href="#__codelineno-0-361">361</a></span>
<span class="normal"><a href="#__codelineno-0-362">362</a></span>
<span class="normal"><a href="#__codelineno-0-363">363</a></span>
<span class="normal"><a href="#__codelineno-0-364">364</a></span>
<span class="normal"><a href="#__codelineno-0-365">365</a></span>
<span class="normal"><a href="#__codelineno-0-366">366</a></span>
<span class="normal"><a href="#__codelineno-0-367">367</a></span>
<span class="normal"><a href="#__codelineno-0-368">368</a></span>
<span class="normal"><a href="#__codelineno-0-369">369</a></span>
<span class="normal"><a href="#__codelineno-0-370">370</a></span>
<span class="normal"><a href="#__codelineno-0-371">371</a></span>
<span class="normal"><a href="#__codelineno-0-372">372</a></span>
<span class="normal"><a href="#__codelineno-0-373">373</a></span>
<span class="normal"><a href="#__codelineno-0-374">374</a></span>
<span class="normal"><a href="#__codelineno-0-375">375</a></span>
<span class="normal"><a href="#__codelineno-0-376">376</a></span>
<span class="normal"><a href="#__codelineno-0-377">377</a></span>
<span class="normal"><a href="#__codelineno-0-378">378</a></span>
<span class="normal"><a href="#__codelineno-0-379">379</a></span>
<span class="normal"><a href="#__codelineno-0-380">380</a></span>
<span class="normal"><a href="#__codelineno-0-381">381</a></span>
<span class="normal"><a href="#__codelineno-0-382">382</a></span>
<span class="normal"><a href="#__codelineno-0-383">383</a></span>
<span class="normal"><a href="#__codelineno-0-384">384</a></span>
<span class="normal"><a href="#__codelineno-0-385">385</a></span>
<span class="normal"><a href="#__codelineno-0-386">386</a></span>
<span class="normal"><a href="#__codelineno-0-387">387</a></span>
<span class="normal"><a href="#__codelineno-0-388">388</a></span>
<span class="normal"><a href="#__codelineno-0-389">389</a></span>
<span class="normal"><a href="#__codelineno-0-390">390</a></span>
<span class="normal"><a href="#__codelineno-0-391">391</a></span>
<span class="normal"><a href="#__codelineno-0-392">392</a></span>
<span class="normal"><a href="#__codelineno-0-393">393</a></span>
<span class="normal"><a href="#__codelineno-0-394">394</a></span>
<span class="normal"><a href="#__codelineno-0-395">395</a></span>
<span class="normal"><a href="#__codelineno-0-396">396</a></span>
<span class="normal"><a href="#__codelineno-0-397">397</a></span>
<span class="normal"><a href="#__codelineno-0-398">398</a></span>
<span class="normal"><a href="#__codelineno-0-399">399</a></span>
<span class="normal"><a href="#__codelineno-0-400">400</a></span>
<span class="normal"><a href="#__codelineno-0-401">401</a></span>
<span class="normal"><a href="#__codelineno-0-402">402</a></span>
<span class="normal"><a href="#__codelineno-0-403">403</a></span>
<span class="normal"><a href="#__codelineno-0-404">404</a></span>
<span class="normal"><a href="#__codelineno-0-405">405</a></span>
<span class="normal"><a href="#__codelineno-0-406">406</a></span>
<span class="normal"><a href="#__codelineno-0-407">407</a></span>
<span class="normal"><a href="#__codelineno-0-408">408</a></span>
<span class="normal"><a href="#__codelineno-0-409">409</a></span>
<span class="normal"><a href="#__codelineno-0-410">410</a></span>
<span class="normal"><a href="#__codelineno-0-411">411</a></span>
<span class="normal"><a href="#__codelineno-0-412">412</a></span>
<span class="normal"><a href="#__codelineno-0-413">413</a></span>
<span class="normal"><a href="#__codelineno-0-414">414</a></span>
<span class="normal"><a href="#__codelineno-0-415">415</a></span>
<span class="normal"><a href="#__codelineno-0-416">416</a></span>
<span class="normal"><a href="#__codelineno-0-417">417</a></span>
<span class="normal"><a href="#__codelineno-0-418">418</a></span>
<span class="normal"><a href="#__codelineno-0-419">419</a></span>
<span class="normal"><a href="#__codelineno-0-420">420</a></span>
<span class="normal"><a href="#__codelineno-0-421">421</a></span>
<span class="normal"><a href="#__codelineno-0-422">422</a></span>
<span class="normal"><a href="#__codelineno-0-423">423</a></span>
<span class="normal"><a href="#__codelineno-0-424">424</a></span>
<span class="normal"><a href="#__codelineno-0-425">425</a></span>
<span class="normal"><a href="#__codelineno-0-426">426</a></span>
<span class="normal"><a href="#__codelineno-0-427">427</a></span>
<span class="normal"><a href="#__codelineno-0-428">428</a></span>
<span class="normal"><a href="#__codelineno-0-429">429</a></span>
<span class="normal"><a href="#__codelineno-0-430">430</a></span>
<span class="normal"><a href="#__codelineno-0-431">431</a></span>
<span class="normal"><a href="#__codelineno-0-432">432</a></span>
<span class="normal"><a href="#__codelineno-0-433">433</a></span>
<span class="normal"><a href="#__codelineno-0-434">434</a></span>
<span class="normal"><a href="#__codelineno-0-435">435</a></span>
<span class="normal"><a href="#__codelineno-0-436">436</a></span>
<span class="normal"><a href="#__codelineno-0-437">437</a></span>
<span class="normal"><a href="#__codelineno-0-438">438</a></span>
<span class="normal"><a href="#__codelineno-0-439">439</a></span>
<span class="normal"><a href="#__codelineno-0-440">440</a></span>
<span class="normal"><a href="#__codelineno-0-441">441</a></span>
<span class="normal"><a href="#__codelineno-0-442">442</a></span>
<span class="normal"><a href="#__codelineno-0-443">443</a></span>
<span class="normal"><a href="#__codelineno-0-444">444</a></span>
<span class="normal"><a href="#__codelineno-0-445">445</a></span>
<span class="normal"><a href="#__codelineno-0-446">446</a></span>
<span class="normal"><a href="#__codelineno-0-447">447</a></span>
<span class="normal"><a href="#__codelineno-0-448">448</a></span>
<span class="normal"><a href="#__codelineno-0-449">449</a></span>
<span class="normal"><a href="#__codelineno-0-450">450</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="k">class</span><span class="w"> </span><span class="nc">Tree</span><span class="p">:</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="sd">    Represents a computational tree structure for model ensemble composition.</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="sd">    The Tree class is a central component in OKAPI, representing a hierarchical structure</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="sd">    of nodes that define how different models are combined. Each tree has a ValueNode as its root,</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="sd">    and may contain multiple ValueNodes and OperatorNodes arranged in a tree structure.</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="sd">    ValueNodes contain tensor data (model predictions), while OperatorNodes define operations</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="sd">    to combine these predictions (such as mean, min, max, weighted mean). The tree&#39;s evaluation</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="sd">    produces a combined prediction by recursively applying these operations.</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a><span class="sd">    Trees can be manipulated through various operations like pruning, appending, and replacing</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="sd">    nodes, making them suitable for evolutionary algorithms where trees evolve over generations.</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="sd">    Attributes:</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="sd">        root: The root node of the tree (must be a ValueNode)</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="sd">        nodes: Dictionary containing lists of all value nodes and operator nodes in the tree</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a><span class="sd">        mutation_chance: Probability of mutation for this tree during evolution</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root</span><span class="p">:</span> <span class="n">ValueNode</span><span class="p">,</span> <span class="n">mutation_chance</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">root</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Creating new tree with root: </span><span class="si">{</span><span class="n">root</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="n">OperatorNode</span><span class="p">):</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Cannot initialize tree with OperatorNode as root&quot;</span><span class="p">)</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Cannot get evaluation of tree with OpNode as root&quot;</span><span class="p">)</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;value_nodes&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;op_nodes&quot;</span><span class="p">:</span> <span class="p">[]}</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mutation_chance</span> <span class="o">=</span> <span class="n">mutation_chance</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">update_nodes</span><span class="p">()</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tree initialized with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;value_nodes&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2"> value nodes and </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;op_nodes&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2"> operator nodes&quot;</span><span class="p">)</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a><span class="sd">        Update the internal collections of nodes in the tree.</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a><span class="sd">        This method traverses the tree and categorizes all nodes into value nodes and operator nodes,</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a><span class="sd">        updating the internal `nodes` dictionary.</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Updating tree node collections&quot;</span><span class="p">)</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;value_nodes&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;op_nodes&quot;</span><span class="p">:</span> <span class="p">[]}</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>        <span class="n">root_nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">get_nodes</span><span class="p">()</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">root_nodes</span><span class="p">:</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ValueNode</span><span class="p">):</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s2">&quot;value_nodes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s2">&quot;op_nodes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Updated nodes: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;value_nodes&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2"> value nodes, </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;op_nodes&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2"> operator nodes&quot;</span><span class="p">)</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>    <span class="nd">@staticmethod</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_tree_from_root</span><span class="p">(</span><span class="n">root</span><span class="p">:</span> <span class="n">ValueNode</span><span class="p">,</span> <span class="n">mutation_chance</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a><span class="sd">        Create a new tree with the given root node.</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a><span class="sd">            root: The ValueNode to use as the root of the new tree</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a><span class="sd">            mutation_chance: Probability of mutation for the new tree</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a><span class="sd">            A new Tree instance</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Creating tree from root node with mutation chance: </span><span class="si">{</span><span class="n">mutation_chance</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>        <span class="n">tree</span> <span class="o">=</span> <span class="n">Tree</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">mutation_chance</span><span class="p">)</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>        <span class="k">return</span> <span class="n">tree</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">evaluation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a><span class="sd">        Calculate and return the evaluation of the tree.</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a><span class="sd">        The evaluation is the result of recursively applying all operations</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a><span class="sd">        in the tree, starting from the root node.</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a><span class="sd">            The tensor resulting from evaluating the tree</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>        <span class="c1"># WARNING: This may not make sense for cases other than binary classification (Squeezing)</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>        <span class="c1"># return B.squeeze(self.root.evaluation if self.root.evaluation is not None else self.root.calculate())</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">evaluation</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">evaluation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">calculate</span><span class="p">()</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">nodes_count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a><span class="sd">        Count the total number of nodes in the tree.</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a><span class="sd">            The sum of value nodes and operator nodes</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s2">&quot;value_nodes&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s2">&quot;op_nodes&quot;</span><span class="p">])</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_clean_evals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a><span class="sd">        Reset the cached evaluation results for all value nodes in the tree.</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a><span class="sd">        This forces recalculation of node evaluations when the tree structure changes.</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Clearing cached evaluations for all value nodes&quot;</span><span class="p">)</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s2">&quot;value_nodes&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>            <span class="n">node</span><span class="o">.</span><span class="n">evaluation</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_clean_values_and_evals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>        <span class="k">for</span> <span class="n">value_node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s2">&quot;value_nodes&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>            <span class="n">value_node</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value_node</span><span class="o">.</span><span class="n">evaluation</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">recalculate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a><span class="sd">        Force recalculation of the tree evaluation.</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a><span class="sd">        This method clears any cached evaluations and triggers a fresh calculation.</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a><span class="sd">        It also updates the nodes dictionary</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a><span class="sd">            The newly calculated evaluation of the tree</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Recalculating tree evaluation&quot;</span><span class="p">)</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_clean_evals</span><span class="p">()</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">update_nodes</span><span class="p">()</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>        <span class="n">evaluation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluation</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;Tree recalculation complete&quot;</span><span class="p">)</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>        <span class="k">return</span> <span class="n">evaluation</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a><span class="sd">        Create a deep copy of the tree.</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a><span class="sd">            A new Tree instance that is a deep copy of the current tree</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Creating deep copy of tree&quot;</span><span class="p">)</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>        <span class="n">root_copy</span><span class="p">:</span> <span class="n">ValueNode</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">ValueNode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">copy_subtree</span><span class="p">())</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>        <span class="k">return</span> <span class="n">Tree</span><span class="o">.</span><span class="n">create_tree_from_root</span><span class="p">(</span><span class="n">root_copy</span><span class="p">)</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">prune_at</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">Node</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Node</span><span class="p">:</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a><span class="sd">        Remove a node and its subtree from the tree.</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a><span class="sd">        This method removes the specified node and all its descendants from the tree.</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a><span class="sd">        If the node is the only child of an operator node, that operator node will</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a><span class="sd">        also be pruned.</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a><span class="sd">            node: The node to prune from the tree</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a><span class="sd">            The pruned node (which is no longer part of the tree). If parent was pruned, the parent will be returned.</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a><span class="sd">        Raises:</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a><span class="sd">            ValueError: If the node is not found in the tree or if attempting to prune the root node</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pruning node from tree: </span><span class="si">{</span><span class="n">node</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>        <span class="k">if</span> <span class="n">node</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s2">&quot;value_nodes&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">node</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s2">&quot;op_nodes&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Attempted to prune node not in tree: </span><span class="si">{</span><span class="n">node</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Node not found in tree&quot;</span><span class="p">)</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Cannot prune root node&quot;</span><span class="p">)</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot prune root node&quot;</span><span class="p">)</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">OperatorNode</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>            <span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">children</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>        <span class="p">):</span>  <span class="c1"># if only child of op node is to be pruned, remove the parent instead</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Node is the only child of operator node, pruning parent: </span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">parent</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">prune_at</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>        <span class="n">subtree_nodes</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">get_nodes</span><span class="p">()</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>        <span class="n">node_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">subtree_nodes</span><span class="p">)</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Removing </span><span class="si">{</span><span class="n">node_count</span><span class="si">}</span><span class="s2"> nodes in subtree&quot;</span><span class="p">)</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>        <span class="k">for</span> <span class="n">subtree_node</span> <span class="ow">in</span> <span class="n">subtree_nodes</span><span class="p">:</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subtree_node</span><span class="p">,</span> <span class="n">ValueNode</span><span class="p">):</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s2">&quot;value_nodes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">subtree_node</span><span class="p">)</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s2">&quot;op_nodes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">subtree_node</span><span class="p">)</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>        <span class="n">node</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">remove_child</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Pruning complete, clearing cached evaluations&quot;</span><span class="p">)</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_clean_evals</span><span class="p">()</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>        <span class="k">return</span> <span class="n">node</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">append_after</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">Node</span><span class="p">,</span> <span class="n">new_node</span><span class="p">:</span> <span class="n">Node</span><span class="p">):</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a><span class="sd">        Append a new node as a child of an existing node.</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a><span class="sd">        The new node must be of a different type than the existing node</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a><span class="sd">        (i.e., value nodes can only append operator nodes and vice versa).</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a><span class="sd">            node: The existing node to which the new node will be appended</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a><span class="sd">            new_node: The new node to append</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a><span class="sd">        Raises:</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a><span class="sd">            ValueError: If the node is not found in the tree or if attempting to append</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a><span class="sd">                       a node of the same type</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Appending node </span><span class="si">{</span><span class="n">new_node</span><span class="si">}</span><span class="s2"> after </span><span class="si">{</span><span class="n">node</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>        <span class="k">if</span> <span class="n">node</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s2">&quot;value_nodes&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">node</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s2">&quot;op_nodes&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Attempted to append to node not in tree: </span><span class="si">{</span><span class="n">node</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Node not found in tree&quot;</span><span class="p">)</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>        <span class="k">if</span> <span class="n">check_if_both_types_same_node_variant</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">node</span><span class="p">),</span> <span class="nb">type</span><span class="p">(</span><span class="n">new_node</span><span class="p">)):</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot append node of same type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">node</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">new_node</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot append node of the same type&quot;</span><span class="p">)</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>        <span class="n">subtree_nodes</span> <span class="o">=</span> <span class="n">new_node</span><span class="o">.</span><span class="n">get_nodes</span><span class="p">()</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adding </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">subtree_nodes</span><span class="p">)</span><span class="si">}</span><span class="s2"> nodes from subtree&quot;</span><span class="p">)</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>        <span class="k">for</span> <span class="n">subtree_node</span> <span class="ow">in</span> <span class="n">subtree_nodes</span><span class="p">:</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subtree_node</span><span class="p">,</span> <span class="n">ValueNode</span><span class="p">):</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s2">&quot;value_nodes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subtree_node</span><span class="p">)</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s2">&quot;op_nodes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subtree_node</span><span class="p">)</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>        <span class="n">node</span><span class="o">.</span><span class="n">add_child</span><span class="p">(</span><span class="n">new_node</span><span class="p">)</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Append complete, clearing cached evaluations&quot;</span><span class="p">)</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_clean_evals</span><span class="p">()</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">replace_at</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">at</span><span class="p">:</span> <span class="n">Node</span><span class="p">,</span> <span class="n">replacement</span><span class="p">:</span> <span class="n">Node</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a><span class="sd">        Replace a node in the tree with another node.</span>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a><span class="sd">        The replacement node must be of the same type as the node being replaced.</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a><span class="sd">        This operation preserves the parent-child relationships.</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a><span class="sd">            at: The node to be replaced</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a><span class="sd">            replacement: The new node that will replace the existing node</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a><span class="sd">            Self reference to allow method chaining</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a><span class="sd">        Raises:</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a><span class="sd">            AssertionError: If the replacement node is not of the same type as the node being replaced</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a>        <span class="k">assert</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">replacement</span><span class="p">,</span> <span class="n">ValueNode</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">ValueNode</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a>            <span class="nb">isinstance</span><span class="p">(</span><span class="n">replacement</span><span class="p">,</span> <span class="n">OperatorNode</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">OperatorNode</span><span class="p">)</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a>        <span class="p">),</span> <span class="s2">&quot;Replacement node must be of the same parent type (ValueNode or OperatorNode) as the node being replaced&quot;</span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a>        <span class="n">at_parent</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">parent</span>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a>        <span class="k">if</span> <span class="n">at_parent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a>            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="n">ValueNode</span><span class="p">),</span> <span class="s2">&quot;Root must be a value node&quot;</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a>            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">replacement</span><span class="p">,</span> <span class="n">ValueNode</span><span class="p">),</span> <span class="s2">&quot;Replacement for root must be a value node&quot;</span>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Node at replacement is root node&quot;</span><span class="p">)</span>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">replacement</span>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a>            <span class="n">at_parent</span><span class="o">.</span><span class="n">replace_child</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">replacement</span><span class="p">)</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">ValueNode</span><span class="p">):</span>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s2">&quot;value_nodes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">at</span><span class="p">)</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s2">&quot;value_nodes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">replacement</span><span class="p">)</span>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s2">&quot;op_nodes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">at</span><span class="p">)</span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s2">&quot;op_nodes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">replacement</span><span class="p">)</span>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_clean_evals</span><span class="p">()</span>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a>        <span class="k">return</span> <span class="bp">self</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_random_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nodes_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">allow_root</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">allow_leaves</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a><span class="sd">        Get a random node from the tree based on specified constraints.</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a><span class="sd">            nodes_type: Optional type of nodes to consider (&#39;value_nodes&#39; or &#39;op_nodes&#39;)</span>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a><span class="sd">                       If None, a random type will be chosen</span>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a><span class="sd">            allow_root: Whether to allow selecting the root node</span>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a><span class="sd">            allow_leaves: Whether to allow selecting leaf nodes</span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a><span class="sd">            A randomly selected node that satisfies the constraints</span>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a><span class="sd">        Raises:</span>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a><span class="sd">            ValueError: If no node satisfying the constraints is found</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">children</span> <span class="o">==</span> <span class="p">[]:</span>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a>            <span class="k">if</span> <span class="n">allow_root</span><span class="p">:</span>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a>                <span class="k">if</span> <span class="n">nodes_type</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">nodes_type</span> <span class="o">==</span> <span class="s2">&quot;value_nodes&quot;</span><span class="p">:</span>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a>                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Tree has only root node and nodes_type is not value_nodes&quot;</span><span class="p">)</span>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Tree has only root node and allow_root is set to False&quot;</span><span class="p">)</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a>        <span class="k">if</span> <span class="n">nodes_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a>            <span class="k">assert</span> <span class="n">nodes_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;value_nodes&quot;</span><span class="p">,</span> <span class="s2">&quot;op_nodes&quot;</span><span class="p">),</span> <span class="sa">f</span><span class="s1">&#39;Unsupported node type &quot;</span><span class="si">{</span><span class="n">nodes_type</span><span class="si">}</span><span class="s1">&quot; selected.&#39;</span>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a>            <span class="n">nodes_types</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a>                <span class="n">nodes_type</span><span class="p">,</span>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a>            <span class="p">]</span>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a>            <span class="n">nodes_types</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">permutation</span><span class="p">([</span><span class="s2">&quot;op_nodes&quot;</span><span class="p">,</span> <span class="s2">&quot;value_nodes&quot;</span><span class="p">]))</span>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a>        <span class="k">for</span> <span class="n">nodes_type</span> <span class="ow">in</span> <span class="n">nodes_types</span><span class="p">:</span>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a>            <span class="k">assert</span> <span class="n">nodes_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Nodes type cannot be None&quot;</span>
<a id="__codelineno-0-309" name="__codelineno-0-309"></a>            <span class="n">order</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">nodes_type</span><span class="p">]))</span>
<a id="__codelineno-0-310" name="__codelineno-0-310"></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">order</span><span class="p">:</span>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a>                <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">nodes_type</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
<a id="__codelineno-0-312" name="__codelineno-0-312"></a>                <span class="k">if</span> <span class="p">(</span><span class="n">allow_leaves</span> <span class="ow">or</span> <span class="n">node</span><span class="o">.</span><span class="n">children</span> <span class="o">!=</span> <span class="p">[])</span> <span class="ow">and</span> <span class="p">(</span><span class="n">allow_root</span> <span class="ow">or</span> <span class="n">node</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">):</span>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a>                    <span class="k">return</span> <span class="n">node</span>
<a id="__codelineno-0-314" name="__codelineno-0-314"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No node found that complies to the constraints&quot;</span><span class="p">)</span>
<a id="__codelineno-0-315" name="__codelineno-0-315"></a>
<a id="__codelineno-0-316" name="__codelineno-0-316"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-317" name="__codelineno-0-317"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">unique_value_node_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-318" name="__codelineno-0-318"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-319" name="__codelineno-0-319"></a><span class="sd">        Get the unique IDs of all value nodes in the tree.</span>
<a id="__codelineno-0-320" name="__codelineno-0-320"></a>
<a id="__codelineno-0-321" name="__codelineno-0-321"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-322" name="__codelineno-0-322"></a><span class="sd">            A list of unique IDs from all value nodes</span>
<a id="__codelineno-0-323" name="__codelineno-0-323"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-324" name="__codelineno-0-324"></a>        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">node</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s2">&quot;value_nodes&quot;</span><span class="p">]]))</span>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a>
<a id="__codelineno-0-326" name="__codelineno-0-326"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-327" name="__codelineno-0-327"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">value_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-328" name="__codelineno-0-328"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s2">&quot;value_nodes&quot;</span><span class="p">]</span>
<a id="__codelineno-0-329" name="__codelineno-0-329"></a>
<a id="__codelineno-0-330" name="__codelineno-0-330"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-331" name="__codelineno-0-331"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">op_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-332" name="__codelineno-0-332"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s2">&quot;op_nodes&quot;</span><span class="p">]</span>
<a id="__codelineno-0-333" name="__codelineno-0-333"></a>
<a id="__codelineno-0-334" name="__codelineno-0-334"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">save_tree_architecture</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_path</span><span class="p">):</span>  <span class="c1"># TODO: needs adjustment for weighted node</span>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a><span class="sd">        Save the tree&#39;s architecture to a file.</span>
<a id="__codelineno-0-337" name="__codelineno-0-337"></a>
<a id="__codelineno-0-338" name="__codelineno-0-338"></a><span class="sd">        This method creates a copy of the tree with tensor values removed</span>
<a id="__codelineno-0-339" name="__codelineno-0-339"></a><span class="sd">        and saves it to the specified path using pickle serialization.</span>
<a id="__codelineno-0-340" name="__codelineno-0-340"></a>
<a id="__codelineno-0-341" name="__codelineno-0-341"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-342" name="__codelineno-0-342"></a><span class="sd">            output_path: Path where the tree architecture will be saved</span>
<a id="__codelineno-0-343" name="__codelineno-0-343"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-344" name="__codelineno-0-344"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saving tree architecture to </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-345" name="__codelineno-0-345"></a>        <span class="n">copy_tree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-0-346" name="__codelineno-0-346"></a>        <span class="n">copy_tree</span><span class="o">.</span><span class="n">_clean_values_and_evals</span><span class="p">()</span>
<a id="__codelineno-0-347" name="__codelineno-0-347"></a>
<a id="__codelineno-0-348" name="__codelineno-0-348"></a>        <span class="n">Pickle</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">copy_tree</span><span class="p">)</span>
<a id="__codelineno-0-349" name="__codelineno-0-349"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Tree architecture saved successfully&quot;</span><span class="p">)</span>
<a id="__codelineno-0-350" name="__codelineno-0-350"></a>
<a id="__codelineno-0-351" name="__codelineno-0-351"></a>    <span class="nd">@staticmethod</span>
<a id="__codelineno-0-352" name="__codelineno-0-352"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">load_tree_architecture</span><span class="p">(</span><span class="n">architecture_path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Tree&quot;</span><span class="p">:</span>  <span class="c1"># TODO: needs adjusted for weighted node</span>
<a id="__codelineno-0-353" name="__codelineno-0-353"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-354" name="__codelineno-0-354"></a><span class="sd">        Load a tree architecture from a file.</span>
<a id="__codelineno-0-355" name="__codelineno-0-355"></a>
<a id="__codelineno-0-356" name="__codelineno-0-356"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-357" name="__codelineno-0-357"></a><span class="sd">            architecture_path: Path to the saved tree architecture file</span>
<a id="__codelineno-0-358" name="__codelineno-0-358"></a>
<a id="__codelineno-0-359" name="__codelineno-0-359"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-360" name="__codelineno-0-360"></a><span class="sd">            The loaded Tree object without tensor values</span>
<a id="__codelineno-0-361" name="__codelineno-0-361"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-362" name="__codelineno-0-362"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading tree architecture from </span><span class="si">{</span><span class="n">architecture_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-363" name="__codelineno-0-363"></a>        <span class="n">tree</span> <span class="o">=</span> <span class="n">Pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">architecture_path</span><span class="p">)</span>
<a id="__codelineno-0-364" name="__codelineno-0-364"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Tree architecture loaded successfully&quot;</span><span class="p">)</span>
<a id="__codelineno-0-365" name="__codelineno-0-365"></a>        <span class="k">return</span> <span class="n">tree</span>
<a id="__codelineno-0-366" name="__codelineno-0-366"></a>
<a id="__codelineno-0-367" name="__codelineno-0-367"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_load_tensors_from_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">preds_directory</span><span class="p">):</span>
<a id="__codelineno-0-368" name="__codelineno-0-368"></a>        <span class="n">current_tensors</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-369" name="__codelineno-0-369"></a>        <span class="n">preds_directory</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">preds_directory</span><span class="p">)</span>
<a id="__codelineno-0-370" name="__codelineno-0-370"></a>        <span class="k">for</span> <span class="n">value_node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s2">&quot;value_nodes&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-371" name="__codelineno-0-371"></a>            <span class="n">node_id</span> <span class="o">=</span> <span class="n">value_node</span><span class="o">.</span><span class="n">id</span>
<a id="__codelineno-0-372" name="__codelineno-0-372"></a>            <span class="k">if</span> <span class="n">node_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">current_tensors</span><span class="p">:</span>
<a id="__codelineno-0-373" name="__codelineno-0-373"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading tensor for node ID: </span><span class="si">{</span><span class="n">node_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-374" name="__codelineno-0-374"></a>                <span class="n">current_tensors</span><span class="p">[</span><span class="n">node_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">B</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">preds_directory</span> <span class="o">/</span> <span class="nb">str</span><span class="p">(</span><span class="n">node_id</span><span class="p">),</span> <span class="n">DEVICE</span><span class="p">)</span>
<a id="__codelineno-0-375" name="__codelineno-0-375"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-376" name="__codelineno-0-376"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using pre-loaded tensor for node ID: </span><span class="si">{</span><span class="n">node_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-377" name="__codelineno-0-377"></a>        <span class="k">return</span> <span class="n">current_tensors</span>
<a id="__codelineno-0-378" name="__codelineno-0-378"></a>
<a id="__codelineno-0-379" name="__codelineno-0-379"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_load_tensors_to_tree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">preds_directory</span><span class="p">,</span> <span class="n">current_tensors</span><span class="p">):</span>
<a id="__codelineno-0-380" name="__codelineno-0-380"></a>        <span class="k">if</span> <span class="n">preds_directory</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-381" name="__codelineno-0-381"></a>            <span class="n">preds_directory</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">preds_directory</span><span class="p">)</span>
<a id="__codelineno-0-382" name="__codelineno-0-382"></a>            <span class="n">loaded_tensors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_tensors_from_path</span><span class="p">(</span><span class="n">preds_directory</span><span class="p">)</span>
<a id="__codelineno-0-383" name="__codelineno-0-383"></a>            <span class="n">current_tensors</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">loaded_tensors</span><span class="p">)</span>
<a id="__codelineno-0-384" name="__codelineno-0-384"></a>        <span class="k">for</span> <span class="n">value_node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s2">&quot;value_nodes&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-385" name="__codelineno-0-385"></a>            <span class="n">node_id</span> <span class="o">=</span> <span class="n">value_node</span><span class="o">.</span><span class="n">id</span>
<a id="__codelineno-0-386" name="__codelineno-0-386"></a>            <span class="n">value_node</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">current_tensors</span><span class="p">[</span><span class="n">node_id</span><span class="p">]</span>
<a id="__codelineno-0-387" name="__codelineno-0-387"></a>        <span class="k">return</span> <span class="n">current_tensors</span>
<a id="__codelineno-0-388" name="__codelineno-0-388"></a>
<a id="__codelineno-0-389" name="__codelineno-0-389"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">do_pred_on_another_tensors</span><span class="p">(</span>
<a id="__codelineno-0-390" name="__codelineno-0-390"></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">preds_directory</span><span class="p">:</span> <span class="kc">None</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">current_tensors</span><span class="p">:</span> <span class="kc">None</span> <span class="o">|</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">return_tree</span><span class="o">=</span><span class="kc">False</span>
<a id="__codelineno-0-391" name="__codelineno-0-391"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="kc">None</span> <span class="o">|</span> <span class="n">Tensor</span><span class="p">,</span> <span class="s2">&quot;Tree&quot;</span><span class="p">]</span> <span class="o">|</span> <span class="n">Tensor</span><span class="p">:</span>
<a id="__codelineno-0-392" name="__codelineno-0-392"></a>        <span class="k">assert</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span>
<a id="__codelineno-0-393" name="__codelineno-0-393"></a>            <span class="p">[</span><span class="n">current_tensors</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="n">preds_directory</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
<a id="__codelineno-0-394" name="__codelineno-0-394"></a>        <span class="p">),</span> <span class="s2">&quot;Either preds directory or current tensors needs to be set, not both&quot;</span>
<a id="__codelineno-0-395" name="__codelineno-0-395"></a>        <span class="k">assert</span> <span class="nb">any</span><span class="p">(</span>
<a id="__codelineno-0-396" name="__codelineno-0-396"></a>            <span class="p">[</span><span class="n">current_tensors</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="n">preds_directory</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
<a id="__codelineno-0-397" name="__codelineno-0-397"></a>        <span class="p">),</span> <span class="s2">&quot;Either preds directory or current tensors needs to be set, none was set&quot;</span>
<a id="__codelineno-0-398" name="__codelineno-0-398"></a>
<a id="__codelineno-0-399" name="__codelineno-0-399"></a>        <span class="n">current_tensors</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-400" name="__codelineno-0-400"></a>        <span class="n">copy_tree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-0-401" name="__codelineno-0-401"></a>        <span class="n">copy_tree</span><span class="o">.</span><span class="n">_clean_values_and_evals</span><span class="p">()</span>
<a id="__codelineno-0-402" name="__codelineno-0-402"></a>        <span class="n">current_tensors</span> <span class="o">=</span> <span class="n">copy_tree</span><span class="o">.</span><span class="n">_load_tensors_to_tree</span><span class="p">(</span><span class="n">preds_directory</span><span class="p">,</span> <span class="n">current_tensors</span><span class="p">)</span>
<a id="__codelineno-0-403" name="__codelineno-0-403"></a>        <span class="k">if</span> <span class="n">return_tree</span><span class="p">:</span>
<a id="__codelineno-0-404" name="__codelineno-0-404"></a>            <span class="k">return</span> <span class="n">copy_tree</span><span class="o">.</span><span class="n">evaluation</span><span class="p">,</span> <span class="n">copy_tree</span>
<a id="__codelineno-0-405" name="__codelineno-0-405"></a>
<a id="__codelineno-0-406" name="__codelineno-0-406"></a>        <span class="k">return</span> <span class="n">copy_tree</span><span class="o">.</span><span class="n">evaluation</span>
<a id="__codelineno-0-407" name="__codelineno-0-407"></a>
<a id="__codelineno-0-408" name="__codelineno-0-408"></a>    <span class="nd">@staticmethod</span>
<a id="__codelineno-0-409" name="__codelineno-0-409"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">load_tree</span><span class="p">(</span><span class="n">architecture_path</span><span class="p">,</span> <span class="n">preds_directory</span><span class="p">,</span> <span class="n">tensors</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="s2">&quot;Tree&quot;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]:</span>
<a id="__codelineno-0-410" name="__codelineno-0-410"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-411" name="__codelineno-0-411"></a><span class="sd">        Load a complete tree with tensor values from files.</span>
<a id="__codelineno-0-412" name="__codelineno-0-412"></a>
<a id="__codelineno-0-413" name="__codelineno-0-413"></a><span class="sd">        This method loads a tree architecture and then loads the associated tensor</span>
<a id="__codelineno-0-414" name="__codelineno-0-414"></a><span class="sd">        values for each value node from the specified directory.</span>
<a id="__codelineno-0-415" name="__codelineno-0-415"></a>
<a id="__codelineno-0-416" name="__codelineno-0-416"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-417" name="__codelineno-0-417"></a><span class="sd">            architecture_path: Path to the saved tree architecture file</span>
<a id="__codelineno-0-418" name="__codelineno-0-418"></a><span class="sd">            preds_directory: Directory containing the tensor files</span>
<a id="__codelineno-0-419" name="__codelineno-0-419"></a><span class="sd">            tensors: Optional dictionary of pre-loaded tensors</span>
<a id="__codelineno-0-420" name="__codelineno-0-420"></a>
<a id="__codelineno-0-421" name="__codelineno-0-421"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-422" name="__codelineno-0-422"></a><span class="sd">            A tuple containing:</span>
<a id="__codelineno-0-423" name="__codelineno-0-423"></a><span class="sd">            - The loaded Tree object with tensor values</span>
<a id="__codelineno-0-424" name="__codelineno-0-424"></a><span class="sd">            - A dictionary of all tensors used in the tree</span>
<a id="__codelineno-0-425" name="__codelineno-0-425"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-426" name="__codelineno-0-426"></a>        <span class="k">if</span> <span class="n">tensors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-427" name="__codelineno-0-427"></a>            <span class="n">tensors</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-428" name="__codelineno-0-428"></a>
<a id="__codelineno-0-429" name="__codelineno-0-429"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading complete tree from </span><span class="si">{</span><span class="n">architecture_path</span><span class="si">}</span><span class="s2"> with tensors from </span><span class="si">{</span><span class="n">preds_directory</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-430" name="__codelineno-0-430"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">tensors</span><span class="p">)</span><span class="si">}</span><span class="s2"> pre-loaded tensors&quot;</span><span class="p">)</span>
<a id="__codelineno-0-431" name="__codelineno-0-431"></a>
<a id="__codelineno-0-432" name="__codelineno-0-432"></a>        <span class="n">current_tensors</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-433" name="__codelineno-0-433"></a>        <span class="n">current_tensors</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">tensors</span><span class="p">)</span>  <span class="c1"># tensors argument is mutable and we do not want to modify it</span>
<a id="__codelineno-0-434" name="__codelineno-0-434"></a>
<a id="__codelineno-0-435" name="__codelineno-0-435"></a>        <span class="n">loaded</span> <span class="o">=</span> <span class="n">Tree</span><span class="o">.</span><span class="n">load_tree_architecture</span><span class="p">(</span><span class="n">architecture_path</span><span class="p">)</span>
<a id="__codelineno-0-436" name="__codelineno-0-436"></a>        <span class="n">current_tensors</span> <span class="o">=</span> <span class="n">loaded</span><span class="o">.</span><span class="n">_load_tensors_to_tree</span><span class="p">(</span><span class="n">preds_directory</span><span class="p">,</span> <span class="n">current_tensors</span><span class="p">)</span>
<a id="__codelineno-0-437" name="__codelineno-0-437"></a>
<a id="__codelineno-0-438" name="__codelineno-0-438"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-439" name="__codelineno-0-439"></a>            <span class="sa">f</span><span class="s2">&quot;Tree loaded successfully with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">loaded</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;value_nodes&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2"> value nodes and </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">loaded</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;op_nodes&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2"> operator nodes&quot;</span>
<a id="__codelineno-0-440" name="__codelineno-0-440"></a>        <span class="p">)</span>
<a id="__codelineno-0-441" name="__codelineno-0-441"></a>        <span class="k">return</span> <span class="n">loaded</span><span class="p">,</span> <span class="n">current_tensors</span>
<a id="__codelineno-0-442" name="__codelineno-0-442"></a>
<a id="__codelineno-0-443" name="__codelineno-0-443"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-444" name="__codelineno-0-444"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-445" name="__codelineno-0-445"></a><span class="sd">        Get a string representation of the tree.</span>
<a id="__codelineno-0-446" name="__codelineno-0-446"></a>
<a id="__codelineno-0-447" name="__codelineno-0-447"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-448" name="__codelineno-0-448"></a><span class="sd">            A string representation formed by concatenating the code of all nodes</span>
<a id="__codelineno-0-449" name="__codelineno-0-449"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-450" name="__codelineno-0-450"></a>        <span class="k">return</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">code</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">get_nodes</span><span class="p">())</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h2 id="okapi.tree.Tree.evaluation" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">evaluation</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

<a href="#okapi.tree.Tree.evaluation" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Calculate and return the evaluation of the tree.</p>
<p>The evaluation is the result of recursively applying all operations
in the tree, starting from the root node.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The tensor resulting from evaluating the tree</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h2 id="okapi.tree.Tree.nodes_count" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">nodes_count</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

<a href="#okapi.tree.Tree.nodes_count" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Count the total number of nodes in the tree.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The sum of value nodes and operator nodes</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h2 id="okapi.tree.Tree.unique_value_node_ids" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">unique_value_node_ids</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

<a href="#okapi.tree.Tree.unique_value_node_ids" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Get the unique IDs of all value nodes in the tree.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of unique IDs from all value nodes</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

    </div>

</div>



<div class="doc doc-object doc-function">


<h2 id="okapi.tree.Tree.__repr__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__repr__</span><span class="p">()</span></code>

<a href="#okapi.tree.Tree.__repr__" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Get a string representation of the tree.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A string representation formed by concatenating the code of all nodes</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>okapi/tree.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-443">443</a></span>
<span class="normal"><a href="#__codelineno-0-444">444</a></span>
<span class="normal"><a href="#__codelineno-0-445">445</a></span>
<span class="normal"><a href="#__codelineno-0-446">446</a></span>
<span class="normal"><a href="#__codelineno-0-447">447</a></span>
<span class="normal"><a href="#__codelineno-0-448">448</a></span>
<span class="normal"><a href="#__codelineno-0-449">449</a></span>
<span class="normal"><a href="#__codelineno-0-450">450</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-443" name="__codelineno-0-443"></a><span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-444" name="__codelineno-0-444"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-445" name="__codelineno-0-445"></a><span class="sd">    Get a string representation of the tree.</span>
<a id="__codelineno-0-446" name="__codelineno-0-446"></a>
<a id="__codelineno-0-447" name="__codelineno-0-447"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-448" name="__codelineno-0-448"></a><span class="sd">        A string representation formed by concatenating the code of all nodes</span>
<a id="__codelineno-0-449" name="__codelineno-0-449"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-450" name="__codelineno-0-450"></a>    <span class="k">return</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">code</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">get_nodes</span><span class="p">())</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="okapi.tree.Tree.append_after" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">append_after</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">new_node</span><span class="p">)</span></code>

<a href="#okapi.tree.Tree.append_after" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Append a new node as a child of an existing node.</p>
<p>The new node must be of a different type than the existing node
(i.e., value nodes can only append operator nodes and vice versa).</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>node</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="okapi.node.Node" href="../nodes/#okapi.node.Node">Node</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The existing node to which the new node will be appended</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>new_node</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="okapi.node.Node" href="../nodes/#okapi.node.Node">Node</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The new node to append</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the node is not found in the tree or if attempting to append
       a node of the same type</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>okapi/tree.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-196" name="__codelineno-0-196"></a><span class="k">def</span><span class="w"> </span><span class="nf">append_after</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">Node</span><span class="p">,</span> <span class="n">new_node</span><span class="p">:</span> <span class="n">Node</span><span class="p">):</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a><span class="sd">    Append a new node as a child of an existing node.</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a><span class="sd">    The new node must be of a different type than the existing node</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a><span class="sd">    (i.e., value nodes can only append operator nodes and vice versa).</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a><span class="sd">        node: The existing node to which the new node will be appended</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a><span class="sd">        new_node: The new node to append</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a><span class="sd">        ValueError: If the node is not found in the tree or if attempting to append</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a><span class="sd">                   a node of the same type</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Appending node </span><span class="si">{</span><span class="n">new_node</span><span class="si">}</span><span class="s2"> after </span><span class="si">{</span><span class="n">node</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>    <span class="k">if</span> <span class="n">node</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s2">&quot;value_nodes&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">node</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s2">&quot;op_nodes&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Attempted to append to node not in tree: </span><span class="si">{</span><span class="n">node</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Node not found in tree&quot;</span><span class="p">)</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>    <span class="k">if</span> <span class="n">check_if_both_types_same_node_variant</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">node</span><span class="p">),</span> <span class="nb">type</span><span class="p">(</span><span class="n">new_node</span><span class="p">)):</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot append node of same type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">node</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">new_node</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot append node of the same type&quot;</span><span class="p">)</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>    <span class="n">subtree_nodes</span> <span class="o">=</span> <span class="n">new_node</span><span class="o">.</span><span class="n">get_nodes</span><span class="p">()</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adding </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">subtree_nodes</span><span class="p">)</span><span class="si">}</span><span class="s2"> nodes from subtree&quot;</span><span class="p">)</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>    <span class="k">for</span> <span class="n">subtree_node</span> <span class="ow">in</span> <span class="n">subtree_nodes</span><span class="p">:</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subtree_node</span><span class="p">,</span> <span class="n">ValueNode</span><span class="p">):</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s2">&quot;value_nodes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subtree_node</span><span class="p">)</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s2">&quot;op_nodes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subtree_node</span><span class="p">)</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>    <span class="n">node</span><span class="o">.</span><span class="n">add_child</span><span class="p">(</span><span class="n">new_node</span><span class="p">)</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Append complete, clearing cached evaluations&quot;</span><span class="p">)</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_clean_evals</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="okapi.tree.Tree.copy" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">copy</span><span class="p">()</span></code>

<a href="#okapi.tree.Tree.copy" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Create a deep copy of the tree.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A new Tree instance that is a deep copy of the current tree</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>okapi/tree.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-137" name="__codelineno-0-137"></a><span class="k">def</span><span class="w"> </span><span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a><span class="sd">    Create a deep copy of the tree.</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a><span class="sd">        A new Tree instance that is a deep copy of the current tree</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Creating deep copy of tree&quot;</span><span class="p">)</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>    <span class="n">root_copy</span><span class="p">:</span> <span class="n">ValueNode</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">ValueNode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">copy_subtree</span><span class="p">())</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>    <span class="k">return</span> <span class="n">Tree</span><span class="o">.</span><span class="n">create_tree_from_root</span><span class="p">(</span><span class="n">root_copy</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="okapi.tree.Tree.create_tree_from_root" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_tree_from_root</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">mutation_chance</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

<a href="#okapi.tree.Tree.create_tree_from_root" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Create a new tree with the given root node.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>root</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="okapi.node.ValueNode" href="../nodes/#okapi.node.ValueNode">ValueNode</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The ValueNode to use as the root of the new tree</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>mutation_chance</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Probability of mutation for the new tree</p>
              </div>
            </td>
            <td>
                  <code>0.1</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A new Tree instance</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>okapi/tree.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-65">65</a></span>
<span class="normal"><a href="#__codelineno-0-66">66</a></span>
<span class="normal"><a href="#__codelineno-0-67">67</a></span>
<span class="normal"><a href="#__codelineno-0-68">68</a></span>
<span class="normal"><a href="#__codelineno-0-69">69</a></span>
<span class="normal"><a href="#__codelineno-0-70">70</a></span>
<span class="normal"><a href="#__codelineno-0-71">71</a></span>
<span class="normal"><a href="#__codelineno-0-72">72</a></span>
<span class="normal"><a href="#__codelineno-0-73">73</a></span>
<span class="normal"><a href="#__codelineno-0-74">74</a></span>
<span class="normal"><a href="#__codelineno-0-75">75</a></span>
<span class="normal"><a href="#__codelineno-0-76">76</a></span>
<span class="normal"><a href="#__codelineno-0-77">77</a></span>
<span class="normal"><a href="#__codelineno-0-78">78</a></span>
<span class="normal"><a href="#__codelineno-0-79">79</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-65" name="__codelineno-0-65"></a><span class="nd">@staticmethod</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a><span class="k">def</span><span class="w"> </span><span class="nf">create_tree_from_root</span><span class="p">(</span><span class="n">root</span><span class="p">:</span> <span class="n">ValueNode</span><span class="p">,</span> <span class="n">mutation_chance</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a><span class="sd">    Create a new tree with the given root node.</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a><span class="sd">        root: The ValueNode to use as the root of the new tree</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a><span class="sd">        mutation_chance: Probability of mutation for the new tree</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a><span class="sd">        A new Tree instance</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Creating tree from root node with mutation chance: </span><span class="si">{</span><span class="n">mutation_chance</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>    <span class="n">tree</span> <span class="o">=</span> <span class="n">Tree</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">mutation_chance</span><span class="p">)</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>    <span class="k">return</span> <span class="n">tree</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="okapi.tree.Tree.get_random_node" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_random_node</span><span class="p">(</span><span class="n">nodes_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">allow_root</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">allow_leaves</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

<a href="#okapi.tree.Tree.get_random_node" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Get a random node from the tree based on specified constraints.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>nodes_type</code>
            </td>
            <td>
                  <code><span title="str">str</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional type of nodes to consider ('value_nodes' or 'op_nodes')
       If None, a random type will be chosen</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>allow_root</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to allow selecting the root node</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>allow_leaves</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to allow selecting leaf nodes</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A randomly selected node that satisfies the constraints</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If no node satisfying the constraints is found</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>okapi/tree.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span>
<span class="normal"><a href="#__codelineno-0-300">300</a></span>
<span class="normal"><a href="#__codelineno-0-301">301</a></span>
<span class="normal"><a href="#__codelineno-0-302">302</a></span>
<span class="normal"><a href="#__codelineno-0-303">303</a></span>
<span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span>
<span class="normal"><a href="#__codelineno-0-306">306</a></span>
<span class="normal"><a href="#__codelineno-0-307">307</a></span>
<span class="normal"><a href="#__codelineno-0-308">308</a></span>
<span class="normal"><a href="#__codelineno-0-309">309</a></span>
<span class="normal"><a href="#__codelineno-0-310">310</a></span>
<span class="normal"><a href="#__codelineno-0-311">311</a></span>
<span class="normal"><a href="#__codelineno-0-312">312</a></span>
<span class="normal"><a href="#__codelineno-0-313">313</a></span>
<span class="normal"><a href="#__codelineno-0-314">314</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-274" name="__codelineno-0-274"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_random_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nodes_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">allow_root</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">allow_leaves</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a><span class="sd">    Get a random node from the tree based on specified constraints.</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a><span class="sd">        nodes_type: Optional type of nodes to consider (&#39;value_nodes&#39; or &#39;op_nodes&#39;)</span>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a><span class="sd">                   If None, a random type will be chosen</span>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a><span class="sd">        allow_root: Whether to allow selecting the root node</span>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a><span class="sd">        allow_leaves: Whether to allow selecting leaf nodes</span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a><span class="sd">        A randomly selected node that satisfies the constraints</span>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a><span class="sd">        ValueError: If no node satisfying the constraints is found</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">children</span> <span class="o">==</span> <span class="p">[]:</span>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a>        <span class="k">if</span> <span class="n">allow_root</span><span class="p">:</span>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a>            <span class="k">if</span> <span class="n">nodes_type</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">nodes_type</span> <span class="o">==</span> <span class="s2">&quot;value_nodes&quot;</span><span class="p">:</span>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Tree has only root node and nodes_type is not value_nodes&quot;</span><span class="p">)</span>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Tree has only root node and allow_root is set to False&quot;</span><span class="p">)</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a>    <span class="k">if</span> <span class="n">nodes_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a>        <span class="k">assert</span> <span class="n">nodes_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;value_nodes&quot;</span><span class="p">,</span> <span class="s2">&quot;op_nodes&quot;</span><span class="p">),</span> <span class="sa">f</span><span class="s1">&#39;Unsupported node type &quot;</span><span class="si">{</span><span class="n">nodes_type</span><span class="si">}</span><span class="s1">&quot; selected.&#39;</span>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a>        <span class="n">nodes_types</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a>            <span class="n">nodes_type</span><span class="p">,</span>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a>        <span class="p">]</span>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a>        <span class="n">nodes_types</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">permutation</span><span class="p">([</span><span class="s2">&quot;op_nodes&quot;</span><span class="p">,</span> <span class="s2">&quot;value_nodes&quot;</span><span class="p">]))</span>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a>    <span class="k">for</span> <span class="n">nodes_type</span> <span class="ow">in</span> <span class="n">nodes_types</span><span class="p">:</span>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a>        <span class="k">assert</span> <span class="n">nodes_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Nodes type cannot be None&quot;</span>
<a id="__codelineno-0-309" name="__codelineno-0-309"></a>        <span class="n">order</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">nodes_type</span><span class="p">]))</span>
<a id="__codelineno-0-310" name="__codelineno-0-310"></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">order</span><span class="p">:</span>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a>            <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">nodes_type</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
<a id="__codelineno-0-312" name="__codelineno-0-312"></a>            <span class="k">if</span> <span class="p">(</span><span class="n">allow_leaves</span> <span class="ow">or</span> <span class="n">node</span><span class="o">.</span><span class="n">children</span> <span class="o">!=</span> <span class="p">[])</span> <span class="ow">and</span> <span class="p">(</span><span class="n">allow_root</span> <span class="ow">or</span> <span class="n">node</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">):</span>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a>                <span class="k">return</span> <span class="n">node</span>
<a id="__codelineno-0-314" name="__codelineno-0-314"></a>    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No node found that complies to the constraints&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="okapi.tree.Tree.load_tree" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">load_tree</span><span class="p">(</span><span class="n">architecture_path</span><span class="p">,</span> <span class="n">preds_directory</span><span class="p">,</span> <span class="n">tensors</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

<a href="#okapi.tree.Tree.load_tree" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Load a complete tree with tensor values from files.</p>
<p>This method loads a tree architecture and then loads the associated tensor
values for each value node from the specified directory.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>architecture_path</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the saved tree architecture file</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>preds_directory</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Directory containing the tensor files</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tensors</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional dictionary of pre-loaded tensors</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="okapi.tree.Tree" href="#okapi.tree.Tree">Tree</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A tuple containing:</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <ul>
<li>The loaded Tree object with tensor values</li>
</ul>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Tuple">Tuple</span>[<a class="autorefs autorefs-internal" title="okapi.tree.Tree" href="#okapi.tree.Tree">Tree</a>, <span title="dict">dict</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <ul>
<li>A dictionary of all tensors used in the tree</li>
</ul>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>okapi/tree.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-408">408</a></span>
<span class="normal"><a href="#__codelineno-0-409">409</a></span>
<span class="normal"><a href="#__codelineno-0-410">410</a></span>
<span class="normal"><a href="#__codelineno-0-411">411</a></span>
<span class="normal"><a href="#__codelineno-0-412">412</a></span>
<span class="normal"><a href="#__codelineno-0-413">413</a></span>
<span class="normal"><a href="#__codelineno-0-414">414</a></span>
<span class="normal"><a href="#__codelineno-0-415">415</a></span>
<span class="normal"><a href="#__codelineno-0-416">416</a></span>
<span class="normal"><a href="#__codelineno-0-417">417</a></span>
<span class="normal"><a href="#__codelineno-0-418">418</a></span>
<span class="normal"><a href="#__codelineno-0-419">419</a></span>
<span class="normal"><a href="#__codelineno-0-420">420</a></span>
<span class="normal"><a href="#__codelineno-0-421">421</a></span>
<span class="normal"><a href="#__codelineno-0-422">422</a></span>
<span class="normal"><a href="#__codelineno-0-423">423</a></span>
<span class="normal"><a href="#__codelineno-0-424">424</a></span>
<span class="normal"><a href="#__codelineno-0-425">425</a></span>
<span class="normal"><a href="#__codelineno-0-426">426</a></span>
<span class="normal"><a href="#__codelineno-0-427">427</a></span>
<span class="normal"><a href="#__codelineno-0-428">428</a></span>
<span class="normal"><a href="#__codelineno-0-429">429</a></span>
<span class="normal"><a href="#__codelineno-0-430">430</a></span>
<span class="normal"><a href="#__codelineno-0-431">431</a></span>
<span class="normal"><a href="#__codelineno-0-432">432</a></span>
<span class="normal"><a href="#__codelineno-0-433">433</a></span>
<span class="normal"><a href="#__codelineno-0-434">434</a></span>
<span class="normal"><a href="#__codelineno-0-435">435</a></span>
<span class="normal"><a href="#__codelineno-0-436">436</a></span>
<span class="normal"><a href="#__codelineno-0-437">437</a></span>
<span class="normal"><a href="#__codelineno-0-438">438</a></span>
<span class="normal"><a href="#__codelineno-0-439">439</a></span>
<span class="normal"><a href="#__codelineno-0-440">440</a></span>
<span class="normal"><a href="#__codelineno-0-441">441</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-408" name="__codelineno-0-408"></a><span class="nd">@staticmethod</span>
<a id="__codelineno-0-409" name="__codelineno-0-409"></a><span class="k">def</span><span class="w"> </span><span class="nf">load_tree</span><span class="p">(</span><span class="n">architecture_path</span><span class="p">,</span> <span class="n">preds_directory</span><span class="p">,</span> <span class="n">tensors</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="s2">&quot;Tree&quot;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]:</span>
<a id="__codelineno-0-410" name="__codelineno-0-410"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-411" name="__codelineno-0-411"></a><span class="sd">    Load a complete tree with tensor values from files.</span>
<a id="__codelineno-0-412" name="__codelineno-0-412"></a>
<a id="__codelineno-0-413" name="__codelineno-0-413"></a><span class="sd">    This method loads a tree architecture and then loads the associated tensor</span>
<a id="__codelineno-0-414" name="__codelineno-0-414"></a><span class="sd">    values for each value node from the specified directory.</span>
<a id="__codelineno-0-415" name="__codelineno-0-415"></a>
<a id="__codelineno-0-416" name="__codelineno-0-416"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-417" name="__codelineno-0-417"></a><span class="sd">        architecture_path: Path to the saved tree architecture file</span>
<a id="__codelineno-0-418" name="__codelineno-0-418"></a><span class="sd">        preds_directory: Directory containing the tensor files</span>
<a id="__codelineno-0-419" name="__codelineno-0-419"></a><span class="sd">        tensors: Optional dictionary of pre-loaded tensors</span>
<a id="__codelineno-0-420" name="__codelineno-0-420"></a>
<a id="__codelineno-0-421" name="__codelineno-0-421"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-422" name="__codelineno-0-422"></a><span class="sd">        A tuple containing:</span>
<a id="__codelineno-0-423" name="__codelineno-0-423"></a><span class="sd">        - The loaded Tree object with tensor values</span>
<a id="__codelineno-0-424" name="__codelineno-0-424"></a><span class="sd">        - A dictionary of all tensors used in the tree</span>
<a id="__codelineno-0-425" name="__codelineno-0-425"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-426" name="__codelineno-0-426"></a>    <span class="k">if</span> <span class="n">tensors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-427" name="__codelineno-0-427"></a>        <span class="n">tensors</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-428" name="__codelineno-0-428"></a>
<a id="__codelineno-0-429" name="__codelineno-0-429"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading complete tree from </span><span class="si">{</span><span class="n">architecture_path</span><span class="si">}</span><span class="s2"> with tensors from </span><span class="si">{</span><span class="n">preds_directory</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-430" name="__codelineno-0-430"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">tensors</span><span class="p">)</span><span class="si">}</span><span class="s2"> pre-loaded tensors&quot;</span><span class="p">)</span>
<a id="__codelineno-0-431" name="__codelineno-0-431"></a>
<a id="__codelineno-0-432" name="__codelineno-0-432"></a>    <span class="n">current_tensors</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-433" name="__codelineno-0-433"></a>    <span class="n">current_tensors</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">tensors</span><span class="p">)</span>  <span class="c1"># tensors argument is mutable and we do not want to modify it</span>
<a id="__codelineno-0-434" name="__codelineno-0-434"></a>
<a id="__codelineno-0-435" name="__codelineno-0-435"></a>    <span class="n">loaded</span> <span class="o">=</span> <span class="n">Tree</span><span class="o">.</span><span class="n">load_tree_architecture</span><span class="p">(</span><span class="n">architecture_path</span><span class="p">)</span>
<a id="__codelineno-0-436" name="__codelineno-0-436"></a>    <span class="n">current_tensors</span> <span class="o">=</span> <span class="n">loaded</span><span class="o">.</span><span class="n">_load_tensors_to_tree</span><span class="p">(</span><span class="n">preds_directory</span><span class="p">,</span> <span class="n">current_tensors</span><span class="p">)</span>
<a id="__codelineno-0-437" name="__codelineno-0-437"></a>
<a id="__codelineno-0-438" name="__codelineno-0-438"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-439" name="__codelineno-0-439"></a>        <span class="sa">f</span><span class="s2">&quot;Tree loaded successfully with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">loaded</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;value_nodes&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2"> value nodes and </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">loaded</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;op_nodes&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2"> operator nodes&quot;</span>
<a id="__codelineno-0-440" name="__codelineno-0-440"></a>    <span class="p">)</span>
<a id="__codelineno-0-441" name="__codelineno-0-441"></a>    <span class="k">return</span> <span class="n">loaded</span><span class="p">,</span> <span class="n">current_tensors</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="okapi.tree.Tree.load_tree_architecture" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">load_tree_architecture</span><span class="p">(</span><span class="n">architecture_path</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

<a href="#okapi.tree.Tree.load_tree_architecture" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Load a tree architecture from a file.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>architecture_path</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the saved tree architecture file</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="okapi.tree.Tree" href="#okapi.tree.Tree">Tree</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The loaded Tree object without tensor values</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>okapi/tree.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-351">351</a></span>
<span class="normal"><a href="#__codelineno-0-352">352</a></span>
<span class="normal"><a href="#__codelineno-0-353">353</a></span>
<span class="normal"><a href="#__codelineno-0-354">354</a></span>
<span class="normal"><a href="#__codelineno-0-355">355</a></span>
<span class="normal"><a href="#__codelineno-0-356">356</a></span>
<span class="normal"><a href="#__codelineno-0-357">357</a></span>
<span class="normal"><a href="#__codelineno-0-358">358</a></span>
<span class="normal"><a href="#__codelineno-0-359">359</a></span>
<span class="normal"><a href="#__codelineno-0-360">360</a></span>
<span class="normal"><a href="#__codelineno-0-361">361</a></span>
<span class="normal"><a href="#__codelineno-0-362">362</a></span>
<span class="normal"><a href="#__codelineno-0-363">363</a></span>
<span class="normal"><a href="#__codelineno-0-364">364</a></span>
<span class="normal"><a href="#__codelineno-0-365">365</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-351" name="__codelineno-0-351"></a><span class="nd">@staticmethod</span>
<a id="__codelineno-0-352" name="__codelineno-0-352"></a><span class="k">def</span><span class="w"> </span><span class="nf">load_tree_architecture</span><span class="p">(</span><span class="n">architecture_path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Tree&quot;</span><span class="p">:</span>  <span class="c1"># TODO: needs adjusted for weighted node</span>
<a id="__codelineno-0-353" name="__codelineno-0-353"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-354" name="__codelineno-0-354"></a><span class="sd">    Load a tree architecture from a file.</span>
<a id="__codelineno-0-355" name="__codelineno-0-355"></a>
<a id="__codelineno-0-356" name="__codelineno-0-356"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-357" name="__codelineno-0-357"></a><span class="sd">        architecture_path: Path to the saved tree architecture file</span>
<a id="__codelineno-0-358" name="__codelineno-0-358"></a>
<a id="__codelineno-0-359" name="__codelineno-0-359"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-360" name="__codelineno-0-360"></a><span class="sd">        The loaded Tree object without tensor values</span>
<a id="__codelineno-0-361" name="__codelineno-0-361"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-362" name="__codelineno-0-362"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading tree architecture from </span><span class="si">{</span><span class="n">architecture_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-363" name="__codelineno-0-363"></a>    <span class="n">tree</span> <span class="o">=</span> <span class="n">Pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">architecture_path</span><span class="p">)</span>
<a id="__codelineno-0-364" name="__codelineno-0-364"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Tree architecture loaded successfully&quot;</span><span class="p">)</span>
<a id="__codelineno-0-365" name="__codelineno-0-365"></a>    <span class="k">return</span> <span class="n">tree</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="okapi.tree.Tree.prune_at" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">prune_at</span><span class="p">(</span><span class="n">node</span><span class="p">)</span></code>

<a href="#okapi.tree.Tree.prune_at" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Remove a node and its subtree from the tree.</p>
<p>This method removes the specified node and all its descendants from the tree.
If the node is the only child of an operator node, that operator node will
also be pruned.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>node</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="okapi.node.Node" href="../nodes/#okapi.node.Node">Node</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The node to prune from the tree</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="okapi.node.Node" href="../nodes/#okapi.node.Node">Node</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The pruned node (which is no longer part of the tree). If parent was pruned, the parent will be returned.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the node is not found in the tree or if attempting to prune the root node</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>okapi/tree.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-148" name="__codelineno-0-148"></a><span class="k">def</span><span class="w"> </span><span class="nf">prune_at</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">Node</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Node</span><span class="p">:</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a><span class="sd">    Remove a node and its subtree from the tree.</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a><span class="sd">    This method removes the specified node and all its descendants from the tree.</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a><span class="sd">    If the node is the only child of an operator node, that operator node will</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a><span class="sd">    also be pruned.</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a><span class="sd">        node: The node to prune from the tree</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a><span class="sd">        The pruned node (which is no longer part of the tree). If parent was pruned, the parent will be returned.</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a><span class="sd">        ValueError: If the node is not found in the tree or if attempting to prune the root node</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pruning node from tree: </span><span class="si">{</span><span class="n">node</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>    <span class="k">if</span> <span class="n">node</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s2">&quot;value_nodes&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">node</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s2">&quot;op_nodes&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Attempted to prune node not in tree: </span><span class="si">{</span><span class="n">node</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Node not found in tree&quot;</span><span class="p">)</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>    <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Cannot prune root node&quot;</span><span class="p">)</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot prune root node&quot;</span><span class="p">)</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">OperatorNode</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>        <span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">children</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>    <span class="p">):</span>  <span class="c1"># if only child of op node is to be pruned, remove the parent instead</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Node is the only child of operator node, pruning parent: </span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">parent</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">prune_at</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>    <span class="n">subtree_nodes</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">get_nodes</span><span class="p">()</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>    <span class="n">node_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">subtree_nodes</span><span class="p">)</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Removing </span><span class="si">{</span><span class="n">node_count</span><span class="si">}</span><span class="s2"> nodes in subtree&quot;</span><span class="p">)</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>    <span class="k">for</span> <span class="n">subtree_node</span> <span class="ow">in</span> <span class="n">subtree_nodes</span><span class="p">:</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subtree_node</span><span class="p">,</span> <span class="n">ValueNode</span><span class="p">):</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s2">&quot;value_nodes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">subtree_node</span><span class="p">)</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s2">&quot;op_nodes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">subtree_node</span><span class="p">)</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>    <span class="n">node</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">remove_child</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Pruning complete, clearing cached evaluations&quot;</span><span class="p">)</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_clean_evals</span><span class="p">()</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>    <span class="k">return</span> <span class="n">node</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="okapi.tree.Tree.recalculate" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">recalculate</span><span class="p">()</span></code>

<a href="#okapi.tree.Tree.recalculate" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Force recalculation of the tree evaluation.</p>
<p>This method clears any cached evaluations and triggers a fresh calculation.
It also updates the nodes dictionary</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The newly calculated evaluation of the tree</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>okapi/tree.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-120" name="__codelineno-0-120"></a><span class="k">def</span><span class="w"> </span><span class="nf">recalculate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a><span class="sd">    Force recalculation of the tree evaluation.</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a><span class="sd">    This method clears any cached evaluations and triggers a fresh calculation.</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a><span class="sd">    It also updates the nodes dictionary</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a><span class="sd">        The newly calculated evaluation of the tree</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Recalculating tree evaluation&quot;</span><span class="p">)</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_clean_evals</span><span class="p">()</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">update_nodes</span><span class="p">()</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>    <span class="n">evaluation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluation</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;Tree recalculation complete&quot;</span><span class="p">)</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>    <span class="k">return</span> <span class="n">evaluation</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="okapi.tree.Tree.replace_at" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">replace_at</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">replacement</span><span class="p">)</span></code>

<a href="#okapi.tree.Tree.replace_at" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Replace a node in the tree with another node.</p>
<p>The replacement node must be of the same type as the node being replaced.
This operation preserves the parent-child relationships.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>at</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="okapi.node.Node" href="../nodes/#okapi.node.Node">Node</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The node to be replaced</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>replacement</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="okapi.node.Node" href="../nodes/#okapi.node.Node">Node</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The new node that will replace the existing node</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Self">Self</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Self reference to allow method chaining</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="AssertionError">AssertionError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the replacement node is not of the same type as the node being replaced</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>okapi/tree.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-234" name="__codelineno-0-234"></a><span class="k">def</span><span class="w"> </span><span class="nf">replace_at</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">at</span><span class="p">:</span> <span class="n">Node</span><span class="p">,</span> <span class="n">replacement</span><span class="p">:</span> <span class="n">Node</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a><span class="sd">    Replace a node in the tree with another node.</span>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a><span class="sd">    The replacement node must be of the same type as the node being replaced.</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a><span class="sd">    This operation preserves the parent-child relationships.</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a><span class="sd">        at: The node to be replaced</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a><span class="sd">        replacement: The new node that will replace the existing node</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a><span class="sd">        Self reference to allow method chaining</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a><span class="sd">        AssertionError: If the replacement node is not of the same type as the node being replaced</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a>    <span class="k">assert</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">replacement</span><span class="p">,</span> <span class="n">ValueNode</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">ValueNode</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a>        <span class="nb">isinstance</span><span class="p">(</span><span class="n">replacement</span><span class="p">,</span> <span class="n">OperatorNode</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">OperatorNode</span><span class="p">)</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a>    <span class="p">),</span> <span class="s2">&quot;Replacement node must be of the same parent type (ValueNode or OperatorNode) as the node being replaced&quot;</span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a>    <span class="n">at_parent</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">parent</span>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a>    <span class="k">if</span> <span class="n">at_parent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="n">ValueNode</span><span class="p">),</span> <span class="s2">&quot;Root must be a value node&quot;</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">replacement</span><span class="p">,</span> <span class="n">ValueNode</span><span class="p">),</span> <span class="s2">&quot;Replacement for root must be a value node&quot;</span>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Node at replacement is root node&quot;</span><span class="p">)</span>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">replacement</span>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a>        <span class="n">at_parent</span><span class="o">.</span><span class="n">replace_child</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">replacement</span><span class="p">)</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">ValueNode</span><span class="p">):</span>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s2">&quot;value_nodes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">at</span><span class="p">)</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s2">&quot;value_nodes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">replacement</span><span class="p">)</span>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s2">&quot;op_nodes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">at</span><span class="p">)</span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s2">&quot;op_nodes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">replacement</span><span class="p">)</span>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_clean_evals</span><span class="p">()</span>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a>    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="okapi.tree.Tree.save_tree_architecture" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">save_tree_architecture</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span></code>

<a href="#okapi.tree.Tree.save_tree_architecture" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Save the tree's architecture to a file.</p>
<p>This method creates a copy of the tree with tensor values removed
and saves it to the specified path using pickle serialization.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>output_path</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path where the tree architecture will be saved</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>okapi/tree.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-334">334</a></span>
<span class="normal"><a href="#__codelineno-0-335">335</a></span>
<span class="normal"><a href="#__codelineno-0-336">336</a></span>
<span class="normal"><a href="#__codelineno-0-337">337</a></span>
<span class="normal"><a href="#__codelineno-0-338">338</a></span>
<span class="normal"><a href="#__codelineno-0-339">339</a></span>
<span class="normal"><a href="#__codelineno-0-340">340</a></span>
<span class="normal"><a href="#__codelineno-0-341">341</a></span>
<span class="normal"><a href="#__codelineno-0-342">342</a></span>
<span class="normal"><a href="#__codelineno-0-343">343</a></span>
<span class="normal"><a href="#__codelineno-0-344">344</a></span>
<span class="normal"><a href="#__codelineno-0-345">345</a></span>
<span class="normal"><a href="#__codelineno-0-346">346</a></span>
<span class="normal"><a href="#__codelineno-0-347">347</a></span>
<span class="normal"><a href="#__codelineno-0-348">348</a></span>
<span class="normal"><a href="#__codelineno-0-349">349</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-334" name="__codelineno-0-334"></a><span class="k">def</span><span class="w"> </span><span class="nf">save_tree_architecture</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_path</span><span class="p">):</span>  <span class="c1"># TODO: needs adjustment for weighted node</span>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a><span class="sd">    Save the tree&#39;s architecture to a file.</span>
<a id="__codelineno-0-337" name="__codelineno-0-337"></a>
<a id="__codelineno-0-338" name="__codelineno-0-338"></a><span class="sd">    This method creates a copy of the tree with tensor values removed</span>
<a id="__codelineno-0-339" name="__codelineno-0-339"></a><span class="sd">    and saves it to the specified path using pickle serialization.</span>
<a id="__codelineno-0-340" name="__codelineno-0-340"></a>
<a id="__codelineno-0-341" name="__codelineno-0-341"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-342" name="__codelineno-0-342"></a><span class="sd">        output_path: Path where the tree architecture will be saved</span>
<a id="__codelineno-0-343" name="__codelineno-0-343"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-344" name="__codelineno-0-344"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saving tree architecture to </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-345" name="__codelineno-0-345"></a>    <span class="n">copy_tree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-0-346" name="__codelineno-0-346"></a>    <span class="n">copy_tree</span><span class="o">.</span><span class="n">_clean_values_and_evals</span><span class="p">()</span>
<a id="__codelineno-0-347" name="__codelineno-0-347"></a>
<a id="__codelineno-0-348" name="__codelineno-0-348"></a>    <span class="n">Pickle</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">copy_tree</span><span class="p">)</span>
<a id="__codelineno-0-349" name="__codelineno-0-349"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Tree architecture saved successfully&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="okapi.tree.Tree.update_nodes" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">update_nodes</span><span class="p">()</span></code>

<a href="#okapi.tree.Tree.update_nodes" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Update the internal collections of nodes in the tree.</p>
<p>This method traverses the tree and categorizes all nodes into value nodes and operator nodes,
updating the internal <code>nodes</code> dictionary.</p>


            <details class="quote">
              <summary>Source code in <code>okapi/tree.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-48">48</a></span>
<span class="normal"><a href="#__codelineno-0-49">49</a></span>
<span class="normal"><a href="#__codelineno-0-50">50</a></span>
<span class="normal"><a href="#__codelineno-0-51">51</a></span>
<span class="normal"><a href="#__codelineno-0-52">52</a></span>
<span class="normal"><a href="#__codelineno-0-53">53</a></span>
<span class="normal"><a href="#__codelineno-0-54">54</a></span>
<span class="normal"><a href="#__codelineno-0-55">55</a></span>
<span class="normal"><a href="#__codelineno-0-56">56</a></span>
<span class="normal"><a href="#__codelineno-0-57">57</a></span>
<span class="normal"><a href="#__codelineno-0-58">58</a></span>
<span class="normal"><a href="#__codelineno-0-59">59</a></span>
<span class="normal"><a href="#__codelineno-0-60">60</a></span>
<span class="normal"><a href="#__codelineno-0-61">61</a></span>
<span class="normal"><a href="#__codelineno-0-62">62</a></span>
<span class="normal"><a href="#__codelineno-0-63">63</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-48" name="__codelineno-0-48"></a><span class="k">def</span><span class="w"> </span><span class="nf">update_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a><span class="sd">    Update the internal collections of nodes in the tree.</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a><span class="sd">    This method traverses the tree and categorizes all nodes into value nodes and operator nodes,</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a><span class="sd">    updating the internal `nodes` dictionary.</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Updating tree node collections&quot;</span><span class="p">)</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;value_nodes&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;op_nodes&quot;</span><span class="p">:</span> <span class="p">[]}</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>    <span class="n">root_nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">get_nodes</span><span class="p">()</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">root_nodes</span><span class="p">:</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ValueNode</span><span class="p">):</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s2">&quot;value_nodes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s2">&quot;op_nodes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Updated nodes: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;value_nodes&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2"> value nodes, </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;op_nodes&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2"> operator nodes&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.instant", "navigation.tracking", "navigation.sections", "navigation.top", "search.highlight", "search.share"], "search": "../../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.c8b220af.min.js"></script>
      
    
  </body>
</html>